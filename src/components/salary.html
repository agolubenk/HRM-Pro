<!DOCTYPE html>
<html lang="ru" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRM System - Современная панель управления</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../static/css/style.css">
    <style>
        body {
            background: #f7f9fb;
        }
        .salary-sidebar {
            min-width: 200px;
            max-width: 240px;
            background: #fff;
            border-radius: 14px 0 0 14px;
            box-shadow: 0 2px 16px 0 rgba(60,72,88,0.07);
            padding: 14px 0 14px 0;
            position: sticky;
            top: 105px;
            z-index: 2;
            margin-right: 0;
            border-right: 1px solid #f0f1f3;
            transition: box-shadow 0.18s, background 0.18s, border-color 0.18s;
        }
        .salary-sidebar .list-group-item {
            border: none;
            background: none;
            font-size: 1.08rem;
            color: #222;
            border-radius: 0 16px 16px 0;
            margin-bottom: 2px;
            padding: 12px 22px 12px 22px;
            transition: background 0.18s, color 0.18s, box-shadow 0.18s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .salary-sidebar .list-group-item.active {
            background: linear-gradient(90deg, #e3f0ff 60%, #f9fafb 100%);
            color: #1976f8;
            box-shadow: 0 2px 8px 0 rgba(25,118,248,0.07);
            font-weight: 600;
            position: relative;
        }
        .salary-sidebar .list-group-item.active::before {
            content: '';
            position: absolute;
            left: 0; top: 8px; bottom: 8px;
            width: 4px;
            border-radius: 4px;
            background: #1976f8;
        }
        .salary-sidebar .list-group-item:focus,
        .salary-sidebar .list-group-item:hover {
            background: #f0f4fa;
            color: #1976f8;
        }
        @media (max-width: 991px) {
            .salary-sidebar { position: static; min-width: 100%; max-width: 100%; border-radius: 10px; margin-bottom: 12px; border-right: none; }
            .salary-sidebar .list-group-item { border-radius: 10px; padding: 10px 12px; }
        }
        .salary-main {
            background: #fff;
            border-radius: 0 14px 14px 0;
            box-shadow: 0 2px 16px 0 rgba(60,72,88,0.07);
            padding: 24px 18px 24px 18px;
            margin-bottom: 108px;
            min-height: calc(100vh - 235px);
            margin-left: 0;
            transition: box-shadow 0.18s, background 0.18s;
        }
        @media (max-width: 991px) {
            .salary-main { padding: 10px 2px; border-radius: 10px; min-height: calc(100vh - 190px); }
        }
        .container-fluid.salary-page {
            padding-top: 105px !important;
            padding-bottom: 0 !important;
        }
        @media (max-width: 991px) {
            .container-fluid.salary-page { padding-top: 105px !important; }
        }
        .salary-main h3 {
            font-size: 1.45rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .salary-main .card {
            border-radius: 12px;
            box-shadow: 0 1px 8px 0 rgba(60,72,88,0.06);
            border: none;
            margin-bottom: 1.5rem;
            background: #fff;
            transition: background 0.18s, box-shadow 0.18s;
        }
        .salary-main .card-header {
            background: #f7fafd;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            font-size: 1.08rem;
            padding: 12px 18px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.18s, border-color 0.18s;
        }
        .salary-main .btn, .salary-main .btn-sm {
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            transition: background 0.15s, color 0.15s;
        }
        .salary-main .table {
            margin-bottom: 0;
            font-size: 1.04rem;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            background: #fff;
            transition: background 0.18s;
        }
        .salary-main .table th {
            background: #f7fafd;
            font-weight: 700;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.18s, border-color 0.18s;
        }
        .salary-main .table td {
            vertical-align: middle;
            border-bottom: 1px solid #f2f3f5;
            transition: border-color 0.18s;
        }
        .salary-main .table tr:last-child td {
            border-bottom: none;
        }
        .salary-main .btn-light {
            background: #f7fafd;
            color: #1976f8;
            border: none;
        }
        .salary-main .btn-light:hover {
            background: #e3f0ff;
            color: #1256b0;
        }
        /* --- Тёмная тема --- */
        html[data-bs-theme="dark"] {
            body {
                background: #181c22;
            }
            .salary-sidebar {
                background: #23272f;
                box-shadow: 0 2px 16px 0 rgba(0,0,0,0.18);
                border-right: 1px solid #23272f;
            }
            .salary-sidebar .list-group-item {
                color: #e3e6eb;
                background: none;
            }
            .salary-sidebar .list-group-item.active {
                background: linear-gradient(90deg, #233a5e 60%, #23272f 100%);
                color: #6ea8fe;
                box-shadow: 0 2px 8px 0 rgba(25,118,248,0.10);
            }
            .salary-sidebar .list-group-item.active::before {
                background: #6ea8fe;
            }
            .salary-sidebar .list-group-item:focus,
            .salary-sidebar .list-group-item:hover {
                background: #232e3c;
                color: #6ea8fe;
            }
            .salary-main {
                background: #23272f;
                box-shadow: 0 2px 16px 0 rgba(0,0,0,0.18);
            }
            .salary-main h3 {
                color: #e3e6eb;
            }
            .salary-main .card {
                background: #23272f;
                box-shadow: 0 1px 8px 0 rgba(0,0,0,0.13);
            }
            .salary-main .card-header {
                background: #232e3c;
                border-bottom: 1px solid #23272f;
                color: #e3e6eb;
            }
            .salary-main .btn, .salary-main .btn-sm {
                background: #232e3c;
                color: #e3e6eb;
                border: 1px solid #343a40;
            }
            .salary-main .btn-light {
                background: #232e3c;
                color: #6ea8fe;
            }
            .salary-main .btn-light:hover {
                background: #233a5e;
                color: #fff;
            }
            .salary-main .table {
                background: #23272f;
                color: #e3e6eb;
            }
            .salary-main .table th {
                background: #232e3c;
                color: #e3e6eb;
                border-bottom: 1px solid #23272f;
            }
            .salary-main .table td {
                border-bottom: 1px solid #232e3c;
                color: #e3e6eb;
            }
        }
        .vacancy-back-btn {
          display: inline-flex;
          align-items: center;
          gap: 0.5em;
          font-size: 1.1rem;
          font-weight: 500;
          color: var(--bs-body-color, #fff);
          background: transparent;
          border: none;
          box-shadow: none;
          padding: 0.25em 0.8em 0.25em 0.8em; /* уменьшен левый отступ */
          border-radius: 0.6em;
          transition: background 0.15s, color 0.15s;
          position: relative;
        }
        .vacancy-back-btn:hover, .vacancy-back-btn:focus {
          background: rgba(255,255,255,0.07);
          color: var(--bs-primary, #1976f8);
          text-decoration: none;
        }
        .vacancy-back-btn i {
          font-size: 1.1em;
          margin-right: 0.4em;
          margin-left: 0;
        }
        /* Мини-стиль для поиска */
        .vacancy-search-input {
          max-width: 160px;
          min-width: 120px;
          height: 32px;
          font-size: 0.98rem;
          padding: 2px 8px;
        }
    </style>
</head>
<body>
    <!-- Главная навигация -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="#" class="logo">
                <i class="bi bi-hexagon-fill"></i>
                <span class="logo-text">HRM Pro</span>
            </a>
            
            <div class="quick-actions">
                <div class="search-container">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Поиск сотрудников, документов, задач..." id="globalSearch">
                    <span class="search-shortcut">Ctrl+K</span>
                </div>
                
                <button class="quick-action-btn d-md-none" onclick="openMobileSearch()">
                    <i class="bi bi-search"></i>
                </button>
                
                <button class="quick-action-btn" onclick="toggleQuickPanel()">
                    <i class="bi bi-lightning-charge"></i>
                </button>
                
                <button class="quick-action-btn" onclick="openNotifications()">
                    <i class="bi bi-bell"></i>
                    <span class="notification-badge">5</span>
                </button>
                
                <div class="dropdown">
                    <button class="quick-action-btn language-btn" data-bs-toggle="dropdown" aria-expanded="false" style="overflow: visible;">
                        <i class="bi bi-globe2"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end language-menu">
                        <li>
                            <a class="dropdown-item language-item active" href="#" onclick="changeLanguage('ru', event)">
                                <span class="language-flag">🇷🇺</span>
                                <span>Русский</span>
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item language-item" href="#" onclick="changeLanguage('en', event)">
                                <span class="language-flag">🇬🇧</span>
                                <span>English</span>
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item language-item" href="#" onclick="changeLanguage('kz', event)">
                                <span class="language-flag">🇰🇿</span>
                                <span>Қазақша</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <button class="quick-action-btn" onclick="toggleTheme()">
                    <i class="bi bi-sun-fill" id="themeIcon"></i>
                </button>
                
                <div class="dropdown">
                    <button class="quick-action-btn" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li class="px-3 py-2">
                            <div class="fw-semibold">Админ Иванов</div>
                            <small class="text-muted">admin@company.com</small>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="account/profile.html"><i class="bi bi-person me-2"></i>Мой профиль</a></li>
                        <li><a class="dropdown-item" href="account/settings.html"><i class="bi bi-gear me-2"></i>Настройки</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-question-circle me-2"></i>Помощь</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-box-arrow-right me-2"></i>Выйти</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Мобильный поиск -->
            <div class="mobile-search-container" id="mobileSearchContainer">
                <input type="text" class="mobile-search-input" placeholder="Поиск..." id="mobileSearchInput">
                <button class="mobile-search-close" onclick="closeMobileSearch()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Подменю модулей -->
    <div class="module-submenu" id="moduleSubmenu">
        <div class="submenu-items" id="submenuItems">
            <!-- Динамически заполняется -->
        </div>
    </div>
    
    <!-- Оверлей для быстрой панели -->
    <div class="panel-overlay" onclick="toggleQuickPanel()"></div>
    
    <!-- Быстрая панель -->
    <div class="quick-panel" id="quickPanel">
        <!-- Недавние -->
        <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection('recent')">
                <h6 class="section-title">Недавние</h6>
                <i class="bi bi-chevron-down section-toggle" id="recent-toggle"></i>
            </div>
            <div class="section-content" id="recent-content">
                <div class="d-flex flex-column gap-2">
                    <a href="#" class="action-card">
                        <div class="action-icon info">
                            <i class="bi bi-person"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">Иван Петров</div>
                            <div class="action-desc">Просмотрен 5 мин назад</div>
                        </div>
                    </a>
                    <a href="#" class="action-card">
                        <div class="action-icon success">
                            <i class="bi bi-file-text"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">Отчет по KPI</div>
                            <div class="action-desc">Изменен час назад</div>
                        </div>
                    </a>
                    <a href="#" class="action-card">
                        <div class="action-icon warning">
                            <i class="bi bi-calendar"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">График отпусков</div>
                            <div class="action-desc">Обновлен сегодня</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Избранное -->
        <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection('favorites')">
                <h6 class="section-title">Избранное</h6>
                <i class="bi bi-chevron-down section-toggle" id="favorites-toggle"></i>
            </div>
            <div class="section-content" id="favorites-content">
                <div class="d-flex flex-column gap-1">
                    <a href="#" class="favorite-item">
                        <i class="bi bi-star-fill text-warning"></i>
                        <span>Табель учета времени</span>
                    </a>
                    <a href="#" class="favorite-item">
                        <i class="bi bi-star-fill text-warning"></i>
                        <span>Заявки на отпуск</span>
                    </a>
                    <a href="#" class="favorite-item">
                        <i class="bi bi-star-fill text-warning"></i>
                        <span>График собеседований</span>
                    </a>
                    <a href="#" class="favorite-item">
                        <i class="bi bi-star-fill text-warning"></i>
                        <span>Штатное расписание</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Модули -->
        <div class="collapsible-section">
            <div class="section-header" onclick="toggleSection('modules')">
                <h6 class="section-title">Модули</h6>
                <i class="bi bi-chevron-down section-toggle" id="modules-toggle"></i>
            </div>
            <div class="section-content" id="modules-content">
                <div class='quick-module-list'>
                    <a href="#" class="quick-module-item" onclick="selectModule('dashboard', event)">
                        <i class="bi bi-speedometer2 quick-module-icon text-primary"></i>
                        <span>Дашборд</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('employees', event)">
                        <i class="bi bi-people quick-module-icon text-info"></i>
                        <span>Сотрудники</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('recruiting', event)">
                        <i class="bi bi-person-plus quick-module-icon text-success"></i>
                        <span>Рекрутинг</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('adaptation', event)">
                        <i class="bi bi-person-check quick-module-icon text-warning"></i>
                        <span>Адаптация</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('cb', event)">
                        <i class="bi bi-cash-stack quick-module-icon text-danger"></i>
                        <span>C&B</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('hrops', event)">
                        <i class="bi bi-gear-wide-connected quick-module-icon text-secondary"></i>
                        <span>HR Operations</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('ld', event)">
                        <i class="bi bi-mortarboard quick-module-icon text-primary"></i>
                        <span>L&D</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('performance', event)">
                        <i class="bi bi-graph-up quick-module-icon text-info"></i>
                        <span>KPI и оценка</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('okr', event)">
                        <i class="bi bi-bullseye quick-module-icon text-success"></i>
                        <span>OKR</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('time', event)">
                        <i class="bi bi-clock-history quick-module-icon text-warning"></i>
                        <span>Учет времени</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('projects', event)">
                        <i class="bi bi-kanban quick-module-icon text-danger"></i>
                        <span>HR-проекты</span>
                    </a>
                    <a href="wiki/wiki.html" class="quick-module-item">
                        <i class="bi bi-book quick-module-icon text-secondary"></i>
                        <span>Wiki</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('corporate', event)">
                        <i class="bi bi-globe quick-module-icon text-primary"></i>
                        <span>Корпоративный портал</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('reports', event)">
                        <i class="bi bi-file-earmark-text quick-module-icon text-info"></i>
                        <span>Отчеты</span>
                    </a>
                    <a href="#" class="quick-module-item" onclick="selectModule('settings', event)">
                        <i class="bi bi-gear quick-module-icon text-secondary"></i>
                        <span>Настройки системы</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Основной контент -->
    <div class="container-fluid salary-page pt-3">
        <div class="row justify-content-center g-0">
            <!-- Левое меню -->
            <div class="col-lg-2 col-md-3">
                <nav class="salary-sidebar mx-lg-0 mx-md-0 mx-auto" id="salaryMenu">
                    <button class="list-group-item list-group-item-action active" data-section="employees"><i class="bi bi-people me-2"></i>Сотрудники</button>
                    <button class="list-group-item list-group-item-action" data-section="ranges"><i class="bi bi-sliders me-2"></i>Вилки</button>
                    <button class="list-group-item list-group-item-action" data-section="benchmarks"><i class="bi bi-bar-chart-line me-2"></i>Бенчмарки</button>
                    <button class="list-group-item list-group-item-action" data-section="vacancies"><i class="bi bi-briefcase me-2"></i>Внешние вакансии</button>
                    <button class="list-group-item list-group-item-action" data-section="report"><i class="bi bi-file-earmark-bar-graph me-2"></i>Общий отчет</button>
                    <button class="list-group-item list-group-item-action" data-section="archive"><i class="bi bi-archive me-2"></i>Архив</button>
                    <button class="list-group-item list-group-item-action" data-section="settings"><i class="bi bi-gear me-2"></i>Настройки</button>
                </nav>
        </div>
            <!-- Правая динамическая область -->
            <div class="col-lg-10 col-md-9 salary-main" id="salaryMainContent">
                <!-- Динамический контент -->
          </div>
        </div>
    </div>
    
    <!-- Футер с задачами -->
    <footer class="tasks-footer" id="tasksFooter">
        <div class="tasks-container" id="tasksContainer">
            <!-- Динамически заполняется задачами -->
        </div>
    </footer>
    
    <!-- Контекстное меню -->
    <div class="context-menu" id="contextMenu">
        <a href="#" class="context-item">
            <i class="bi bi-folder-plus"></i>
            <span>Создать папку</span>
        </a>
        <a href="#" class="context-item">
            <i class="bi bi-file-earmark-plus"></i>
            <span>Новый документ</span>
        </a>
        <div class="context-divider"></div>
        <a href="#" class="context-item">
            <i class="bi bi-star"></i>
            <span>Добавить в избранное</span>
        </a>
        <a href="#" class="context-item">
            <i class="bi bi-share"></i>
            <span>Поделиться</span>
        </a>
        <div class="context-divider"></div>
        <a href="#" class="context-item text-danger">
            <i class="bi bi-trash"></i>
            <span>Удалить</span>
        </a>
    </div>
    
    <!-- Плавающие действия -->
    <div class="floating-actions">
        <button class="fab secondary" onclick="scrollToTop()">
            <i class="bi bi-arrow-up"></i>
        </button>
        <button class="fab" onclick="openCreateMenu()">
            <i class="bi bi-plus-lg"></i>
        </button>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
                // --- ДАННЫЕ И ФУНКЦИЯ ДЛЯ АРХИВА ---
                const archivedVacanciesData = [
          {
            id: 'hh-12345',
            source: 'hh',
            title: 'Senior Frontend Developer',
            location: 'Москва',
            company: 'Tech Solutions',
            salary_from: 300000,
            salary_to: 400000,
            currency: 'RUB',
            archived_at: '2024-06-10T10:00:00'
          },
          {
            id: 'ln-67890',
            source: 'ln',
            title: 'Product Manager',
            location: 'Санкт-Петербург',
            company: 'Digital Innovations',
            salary_from: 250000,
            salary_to: 350000,
            currency: 'RUB',
            archived_at: '2024-06-08T12:15:00'
          },
          {
            id: 'tg-54321',
            source: 'tg',
            title: 'DevOps Engineer',
            location: 'Удаленно',
            company: 'Cloud Systems',
            salary_from: 280000,
            salary_to: 380000,
            currency: 'RUB',
            archived_at: '2024-06-09T16:45:00'
          },
          {
            id: 'ex-11111',
            source: 'ex',
            title: 'QA Engineer',
            location: 'Казань',
            company: 'QA Systems',
            salary_from: 200000,
            salary_to: 250000,
            currency: 'RUB',
            archived_at: '2024-06-07T09:00:00'
          },
          {
            id: 'tb-22222',
            source: 'tb',
            title: 'Business Analyst',
            location: 'Екатеринбург',
            company: 'Analytics Pro',
            salary_from: 270000,
            salary_to: 320000,
            currency: 'RUB',
            archived_at: '2024-06-06T11:30:00'
          },
          {
            id: 'hc-33333',
            source: 'hc',
            title: 'UI/UX Designer',
            location: 'Новосибирск',
            company: 'Design Studio',
            salary_from: 260000,
            salary_to: 310000,
            currency: 'RUB',
            archived_at: '2024-06-05T14:20:00'
          },
          {
            id: 'hh-44444',
            source: 'hh',
            title: 'Backend Developer',
            location: 'Калининград',
            company: 'Backend Corp',
            salary_from: 320000,
            salary_to: 420000,
            currency: 'RUB',
            archived_at: '2024-06-04T10:10:00'
          },
          {
            id: 'ln-55555',
            source: 'ln',
            title: 'HR Specialist',
            location: 'Воронеж',
            company: 'HR Group',
            salary_from: 210000,
            salary_to: 260000,
            currency: 'RUB',
            archived_at: '2024-06-03T13:00:00'
          },
          {
            id: 'tg-66666',
            source: 'tg',
            title: 'Project Manager',
            location: 'Казань',
            company: 'PM Experts',
            salary_from: 350000,
            salary_to: 450000,
            currency: 'RUB',
            archived_at: '2024-06-02T15:45:00'
          },
          {
            id: 'ex-77777',
            source: 'ex',
            title: 'System Analyst',
            location: 'Москва',
            company: 'SysAnalytica',
            salary_from: 240000,
            salary_to: 290000,
            currency: 'RUB',
            archived_at: '2024-06-01T17:30:00'
          },
          {
            id: 'tb-88888',
            source: 'tb',
            title: 'Marketing Lead',
            location: 'Сочи',
            company: 'MarketLead',
            salary_from: 330000,
            salary_to: 390000,
            currency: 'RUB',
            archived_at: '2024-05-31T12:00:00'
          },
          {
            id: 'hc-99999',
            source: 'hc',
            title: 'Support Engineer',
            location: 'Пермь',
            company: 'SupportPro',
            salary_from: 180000,
            salary_to: 230000,
            currency: 'RUB',
            archived_at: '2024-05-30T09:30:00'
          }
        ];

        // 1. Добавляю ещё 4 вакансии:
        archivedVacanciesData.push(
          { id: 'hh-10101', source: 'hh', title: 'Frontend Intern', location: 'Москва', company: 'Tech Solutions', salary_from: 100000, salary_to: 150000, currency: 'RUB', archived_at: '2024-05-29T10:00:00' },
          { id: 'ln-20202', source: 'ln', title: 'Junior Product Manager', location: 'Санкт-Петербург', company: 'Digital Innovations', salary_from: 120000, salary_to: 170000, currency: 'RUB', archived_at: '2024-05-28T12:15:00' },
          { id: 'tg-30303', source: 'tg', title: 'DevOps Trainee', location: 'Удаленно', company: 'Cloud Systems', salary_from: 110000, salary_to: 160000, currency: 'RUB', archived_at: '2024-05-27T16:45:00' },
          { id: 'ex-40404', source: 'ex', title: 'QA Trainee', location: 'Казань', company: 'QA Systems', salary_from: 90000, salary_to: 120000, currency: 'RUB', archived_at: '2024-05-26T09:00:00' }
        );

        function formatArchivedTime(dateString) {
          const now = new Date();
          const archived = new Date(dateString);
          const diff = now - archived;
          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          if (days > 0) return `${days} д. назад`;
          if (hours > 0) return `${hours} ч. назад`;
          return `${minutes} мин. назад`;
        }

        function renderArchivedTable(page = 1, perPage = 10, search = '', channel = '') {
          if (typeof page === 'undefined') page = 1;
          let filtered = archivedVacanciesData.filter(v => {
            const q = search.trim().toLowerCase();
            if (channel && v.source !== channel) return false;
            if (!q) return true;
            return (
              (v.source ? v.source + '-' : '') + v.id
            ).toLowerCase().includes(q) ||
              v.title.toLowerCase().includes(q) ||
              v.location.toLowerCase().includes(q) ||
              v.company.toLowerCase().includes(q);
          });
          const total = filtered.length;
          const totalPages = Math.ceil(total / perPage);
          const start = (page - 1) * perPage;
          const end = start + perPage;
          const items = filtered.slice(start, end);
          document.getElementById('salaryMainContent').innerHTML = `
            <div class='d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2'>
              <h3 class='mb-0'><i class="bi bi-archive me-2"></i>Архив вакансий <span class='text-muted fs-6'>(${total})</span></h3>
              <div class='d-flex gap-2'>
                <select class='form-select form-select-sm' id='archivedChannelSelect' style='width:160px; min-width:120px; height:32px;'>
                  ${channelOptions.map(opt => `<option value='${opt.value}'${opt.value===channel?" selected":''}>${opt.label}</option>`).join('')}
                </select>
                <input type='text' class='form-control form-control-sm vacancy-search-input' style='width:160px; height:32px; font-size:0.98rem;' placeholder='Поиск...' id='archivedSearchInput' value='${search.replace(/'/g, "&#39;")}' autocomplete='off' />
              </div>
            </div>
            <div class='table-responsive'>
              <table class='table table-hover align-middle small p-0' style='font-size:0.92rem;'>
                <thead class='table-light'>
                  <tr>
                    <th style='width: 100px'>ID</th>
                    <th>Название</th>
                    <th>Локация</th>
                    <th>ЗП от</th>
                    <th>ЗП до</th>
                    <th>Валюта</th>
                    <th>В архиве</th>
                    <th style='width: 100px'>Действие</th>
                  </tr>
                </thead>
                <tbody>
                  ${items.map(v => `
                    <tr>
                      <td class='text-muted'>${v.id}</td>
                      <td>
                        <div class='fw-medium'>${v.title}</div>
                        <div class='text-muted small'>${v.company}</div>
                      </td>
                      <td>${v.location}</td>
                      <td>${v.salary_from?.toLocaleString() || '-'}</td>
                      <td>${v.salary_to?.toLocaleString() || '-'}</td>
                      <td>${v.currency || 'RUB'}</td>
                      <td class='text-muted'>${formatArchivedTime(v.archived_at)}</td>
                      <td>
                        <button class='btn btn-sm btn-outline-secondary vacancy-info-btn' data-id='${v.id}' data-source='${v.source}' data-archive='1'>Info</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${renderPagination(page, totalPages, (p) => renderArchivedTable(p, perPage, search, channel))}
          `;
          setTimeout(() => {
            const channelSelect = document.getElementById('archivedChannelSelect');
            if (channelSelect && !channelSelect._handler) {
              channelSelect._handler = true;
              channelSelect.addEventListener('change', function() {
                renderArchivedTable(1, perPage, document.getElementById('archivedSearchInput')?.value || '', this.value);
              });
            }
            const searchInput = document.getElementById('archivedSearchInput');
            if (searchInput && !searchInput._debounced) {
              let debounceTimer;
              searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                const val = this.value;
                const channelVal = document.getElementById('archivedChannelSelect')?.value || '';
                debounceTimer = setTimeout(() => {
                  renderArchivedTable(1, perPage, val, channelVal);
                  setTimeout(() => {
                    const newInput = document.getElementById('archivedSearchInput');
                    if (newInput) {
                      newInput.focus();
                      newInput.setSelectionRange(val.length, val.length);
                    }
                  }, 0);
                }, 200);
              });
              searchInput._debounced = true;
            }
          }, 0);
        }

        // Данные зафиксированных задач
        let pinnedTasks = [
            { id: 1, text: 'Собеседование: Петров Иван Иванович - Senior Developer', type: 'interview' },
            { id: 2, text: 'Оформить отпуск: Сидорова А.В. (15.06-29.06)', type: 'vacation' },
            { id: 3, text: 'Проверить табель отдела разработки за май', type: 'timesheet' },
            { id: 4, text: 'Подготовить квартальный отчет по KPI', type: 'report' },
            { id: 5, text: 'Планерка HR-отдела в 14:00', type: 'meeting' },
            { id: 6, text: 'Обновить вакансию: Product Manager', type: 'vacancy' },
            { id: 7, text: 'Рассмотреть 5 заявок на корп. обучение', type: 'training' },
            { id: 8, text: 'Согласовать премии за Q2 2025', type: 'bonus' },
            { id: 9, text: 'Телефонное интервью: Иванова М.П. в 11:00', type: 'interview' },
            { id: 10, text: '1-й день адаптации: Козлов Д.А. (встретить в 9:00)', type: 'adaptation' },
            { id: 11, text: 'Актуализировать оргструктуру отдела продаж', type: 'structure' },
            { id: 12, text: 'Проверить больничные: 3 новых листа', type: 'sick' },
            { id: 13, text: 'Составить план обучения на Q3 2025', type: 'training' },
            { id: 14, text: 'Финальное интервью: Смирнов В.А. - Team Lead', type: 'interview' },
            { id: 15, text: 'Подготовить презентацию для собрания', type: 'presentation' },
            { id: 16, text: 'Оценка 360: завершить опросы до 30.05', type: 'performance' },
            { id: 17, text: 'Заказать пропуска для 3 новых сотрудников', type: 'hrops' },
            { id: 18, text: 'Встреча с юристом: трудовые споры в 16:00', type: 'meeting' },
            { id: 19, text: 'Проверить резюме: 12 новых откликов', type: 'recruiting' },
            { id: 20, text: 'Обновить должностные инструкции IT-отдела', type: 'documents' },
            { id: 21, text: 'Организовать тимбилдинг на 15.06', type: 'event' },
            { id: 22, text: 'Согласовать изменение графика: Морозов П.С.', type: 'schedule' },
            { id: 23, text: 'Exit-интервью: Кузнецова Е.А. в 15:00', type: 'interview' },
            { id: 24, text: 'Подписать приказы о переводе (3 шт.)', type: 'documents' },
            { id: 25, text: 'Обзвон кандидатов на вакансию HR BP', type: 'recruiting' },
            { id: 26, text: 'Составить отчет по текучести кадров', type: 'analytics' },
            { id: 27, text: 'Проверить компенсации: индексация ЗП', type: 'compensation' },
            { id: 28, text: 'Встреча с руководителями: план найма Q3', type: 'meeting' },
            { id: 29, text: 'Обновить базу контактов сотрудников', type: 'database' },
            { id: 30, text: 'Запустить опрос удовлетворенности', type: 'survey' }
        ];
        
        // Структура подменю для каждого модуля
        const moduleSubmenus = {
            dashboard: null, // Дашборд не имеет подменю
            employees: [
                { icon: 'bi-people', text: 'Все сотрудники', active: true },
                { icon: 'bi-person-badge', text: 'Профили' },
                { icon: 'bi-building', text: 'Отделы' },
                { icon: 'bi-diagram-3', text: 'Оргструктура' },
                { icon: 'bi-person-lines-fill', text: 'Контакты' }
            ],
            recruiting: [
                { icon: 'bi-briefcase', text: 'Вакансии', active: true },
                { icon: 'bi-person-plus', text: 'Кандидаты' },
                { icon: 'bi-calendar-check', text: 'Интервью' },
                { icon: 'bi-clipboard-check', text: 'Оценка' },
                { icon: 'bi-graph-up', text: 'Воронка' }
            ],
            adaptation: [
                { icon: 'bi-person-check', text: 'Новички', active: true },
                { icon: 'bi-list-check', text: 'Планы' },
                { icon: 'bi-clipboard2-check', text: 'Чек-листы' },
                { icon: 'bi-person-workspace', text: 'Наставники' },
                { icon: 'bi-bar-chart', text: 'Прогресс' }
            ],
            cb: [
                { icon: 'bi-speedometer2', text: 'Дашборд'},
                { icon: 'bi-cash-stack', text: 'Зарплаты', active: true},
                { icon: 'bi-gift', text: 'Бонусы' },
                { icon: 'bi-award', text: 'Льготы' },
                { icon: 'bi-calculator', text: 'Калькулятор' },
                { icon: 'bi-file-earmark-bar-graph', text: 'Грейды' },
                { icon: 'bi-gear', text: 'Настройки' } // Новый пункт меню
            ],
            hrops: [
                { icon: 'bi-gear-wide-connected', text: 'Процессы', active: true },
                { icon: 'bi-file-earmark-text', text: 'Документы' },
                { icon: 'bi-envelope', text: 'Заявки' },
                { icon: 'bi-shield-check', text: 'Compliance' },
                { icon: 'bi-robot', text: 'Автоматизация' }
            ],
            ld: [
                { icon: 'bi-mortarboard', text: 'Курсы', active: true },
                { icon: 'bi-book', text: 'Программы' },
                { icon: 'bi-trophy', text: 'Сертификаты' },
                { icon: 'bi-people', text: 'Тренеры' },
                { icon: 'bi-calendar3', text: 'Расписание' }
            ],
            performance: [
                { icon: 'bi-speedometer2', text: 'KPI', active: true },
                { icon: 'bi-star', text: 'Оценка' },
                { icon: 'bi-bullseye', text: 'Цели' },
                { icon: 'bi-chat-square-dots', text: 'Фидбек' },
                { icon: 'bi-arrow-up-right', text: 'Развитие' }
            ],
            okr: [
                { icon: 'bi-bullseye', text: 'Цели компании', active: true },
                { icon: 'bi-diagram-3', text: 'Каскадирование' },
                { icon: 'bi-bar-chart-line', text: 'Прогресс' },
                { icon: 'bi-flag', text: 'Ключевые результаты' },
                { icon: 'bi-clock-history', text: 'История' }
            ],
            time: [
                { icon: 'bi-clock', text: 'Табель', active: true },
                { icon: 'bi-calendar-week', text: 'График' },
                { icon: 'bi-airplane', text: 'Отпуска' },
                { icon: 'bi-heart-pulse', text: 'Больничные' },
                { icon: 'bi-stopwatch', text: 'Переработки' }
            ],
            projects: [
                { icon: 'bi-kanban', text: 'Все проекты', active: true },
                { icon: 'bi-list-task', text: 'Задачи' },
                { icon: 'bi-diagram-2', text: 'Roadmap' },
                { icon: 'bi-people-fill', text: 'Команды' },
                { icon: 'bi-pie-chart', text: 'Отчеты' }
            ],
            wiki: [
                { icon: 'bi-house-door', text: 'Главная', active: true },
                { icon: 'bi-folder2-open', text: 'Категории' },
                { icon: 'bi-file-text', text: 'Статьи' },
                { icon: 'bi-search', text: 'Поиск' },
                { icon: 'bi-clock-history', text: 'Недавние' }
            ],
            corporate: [
                { icon: 'bi-newspaper', text: 'Новости', active: true },
                { icon: 'bi-calendar-event', text: 'События' },
                { icon: 'bi-megaphone', text: 'Объявления' },
                { icon: 'bi-images', text: 'Галерея' },
                { icon: 'bi-info-circle', text: 'О компании' }
            ],
            reports: [
                { icon: 'bi-file-earmark-bar-graph', text: 'Дашборды', active: true },
                { icon: 'bi-file-earmark-excel', text: 'Экспорт' },
                { icon: 'bi-sliders', text: 'Конструктор' },
                { icon: 'bi-bookmark', text: 'Избранное' },
                { icon: 'bi-clock-history', text: 'История' }
            ],
            settings: [
                { icon: 'bi-sliders', text: 'Общие', active: true },
                { icon: 'bi-people', text: 'Пользователи' },
                { icon: 'bi-shield-lock', text: 'Безопасность' },
                { icon: 'bi-plug', text: 'Интеграции' },
                { icon: 'bi-palette', text: 'Внешний вид' }
            ]
        };
        
        // Инициализация футера с задачами
        function initTasksFooter() {
            updateTasksDisplay();
        }
        
        // Обновление отображения задач с улучшенной логикой
        function updateTasksDisplay() {
            const container = document.getElementById('tasksContainer');
            if (!container) return;
            
            function truncateText(text, maxLength = 20) {
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength) + '...';
            }
            
            setTimeout(() => {
            const containerWidth = container.offsetWidth || window.innerWidth - 32;
            const maxVisibleWidth = Math.max(containerWidth - 150, 200);
            
            let htmlTasks = '';
            let currentWidth = 0;
            let visibleTasks = [];
            let hiddenTasks = [];
            
            if (pinnedTasks.length === 0) {
                container.innerHTML = '<span class="text-muted">© Иван Голубенко, 2023–2024 | HRM Pro v1.0</span>';
                return;
            }
            
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.visibility = 'hidden';
            tempDiv.style.whiteSpace = 'nowrap';
            tempDiv.className = 'task-badge';
            document.body.appendChild(tempDiv);
            
            pinnedTasks.forEach(task => {
                const truncatedText = truncateText(task.text);
                tempDiv.innerHTML = `${truncatedText}<button class="close-btn">×</button>`;
                const taskWidth = tempDiv.offsetWidth + 8;
                if (currentWidth + taskWidth <= maxVisibleWidth) {
                    visibleTasks.push(task);
                    currentWidth += taskWidth;
                } else {
                    hiddenTasks.push(task);
                }
            });
            document.body.removeChild(tempDiv);
            
                // Формируем задачи в обычном порядке (слева направо)
            visibleTasks.forEach(task => {
                const truncatedText = truncateText(task.text);
                htmlTasks += `
                    <span class="task-badge" onclick="openTask(${task.id})" title="${task.text}">
                        <button class="close-btn" onclick="removeTask(${task.id}, event)">×</button>
                        ${truncatedText}
                    </span>
                `;
            });
            
            let html = htmlTasks;
                // Кнопка скрытых задач всегда самая правая
            if (hiddenTasks.length > 0) {
                html += `
                    <button class="tasks-overflow-btn" onclick="toggleTasksDropdown(event)" type="button" id="tasksOverflowBtn">
                        <i class="bi bi-list"></i>
                        <span>+${hiddenTasks.length}</span>
                    </button>
                `;
                let dropdown = document.getElementById('tasksDropdown');
                if (dropdown) {
                    dropdown.remove();
                }
                dropdown = document.createElement('div');
                dropdown.className = 'tasks-dropdown';
                dropdown.id = 'tasksDropdown';
                    // Только контейнер задач-пилюль, без заголовков и лишних оберток
                    dropdown.innerHTML = `<div class="tasks-container">${
                        hiddenTasks.map(task => `
                            <span class=\"task-badge\" onclick=\"openTask(${task.id})\" title=\"${task.text}\">
                                <button class=\"close-btn\" onclick=\"removeTask(${task.id}, event)\">×</button>
                                ${task.text}
                            </span>
                        `).join('')
                    }</div>`;
                document.body.appendChild(dropdown);
                }
            container.innerHTML = html;
            }, 100);
        }
        
        // Показать/скрыть выпадающий список задач
        function toggleTasksDropdown(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropdown = document.getElementById('tasksDropdown');
            const button = document.getElementById('tasksOverflowBtn');
            
            if (!dropdown || !button) return;
            
            const isShowing = dropdown.classList.contains('show');
            
            if (isShowing) {
                dropdown.classList.remove('show');
            } else {
                // Позиционируем dropdown так, чтобы правая граница совпадала с правой границей кнопки
                const buttonRect = button.getBoundingClientRect();
                const dropdownWidth = dropdown.offsetWidth;
                const windowWidth = window.innerWidth;
                
                // Новое позиционирование по right
                let rightPosition = windowWidth - buttonRect.right;
                dropdown.style.position = 'fixed';
                dropdown.style.right = rightPosition + 'px';
                dropdown.style.left = 'auto';
                dropdown.style.bottom = (window.innerHeight - buttonRect.top + 8) + 'px';
                
                dropdown.classList.add('show');
                
                // Закрытие при клике вне
                setTimeout(() => {
                    function closeDropdown(e) {
                        if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                            dropdown.classList.remove('show');
                            document.removeEventListener('click', closeDropdown);
                        }
                    }
                    document.addEventListener('click', closeDropdown);
                }, 0);
            }
        }
        
        // Открыть задачу
        function openTask(taskId) {
            const task = pinnedTasks.find(t => t.id === taskId);
            if (task) {
                showNotification(`Открыта задача: ${task.text}`);
            }
        }
        
        // Удалить задачу
        function removeTask(taskId, event) {
            event.stopPropagation();
            pinnedTasks = pinnedTasks.filter(t => t.id !== taskId);
            updateTasksDisplay();
            showNotification('Задача удалена из закрепленных');
        }
        
        // Функция добавления новой задачи
        function addPinnedTask(taskText) {
            const newTask = {
                id: Math.max(...pinnedTasks.map(t => t.id)) + 1,
                text: taskText,
                type: 'custom'
            };
            pinnedTasks.push(newTask);
            updateTasksDisplay();
            showNotification('Задача добавлена в закрепленные');
        }
        
        // Функция для отладки задач
        function debugTasks() {
            console.log('Количество задач:', pinnedTasks.length);
            console.log('Контейнер:', document.getElementById('tasksContainer'));
            console.log('Ширина контейнера:', document.getElementById('tasksContainer')?.offsetWidth);
                updateTasksDisplay();
        }
        
        // Переключение подменю при выборе модуля
        function updateSubmenu(moduleKey) {
            const submenu = document.getElementById('moduleSubmenu');
            const submenuItems = document.getElementById('submenuItems');
            const contentArea = document.getElementById('contentArea');
            if (!submenu || !submenuItems || !contentArea) return;
            
            const items = moduleSubmenus[moduleKey];
            
            if (!items) {
                submenu.classList.remove('show');
                contentArea.classList.remove('with-submenu');
                return;
            }
            
            submenuItems.innerHTML = items.map(item => `
                <a href="#" class="submenu-item ${item.active ? 'active' : ''}">
                    <i class="bi ${item.icon}"></i>
                    <span>${item.text}</span>
                </a>
            `).join('');
            
            submenu.classList.add('show');
            contentArea.classList.add('with-submenu');
            
            // Добавляем обработчики для подменю
            document.querySelectorAll('.submenu-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelectorAll('.submenu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        // Выбор модуля из быстрой панели
        function selectModule(moduleKey, event) {
            event.preventDefault();
            
            // Находим и активируем соответствующую карточку модуля
            document.querySelectorAll('.module-card').forEach(card => {
                if (card.dataset.module === moduleKey) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
            
            updateSubmenu(moduleKey);
            toggleQuickPanel();
        }
        
        // Контекстное меню
        document.addEventListener('contextmenu', function(e) {
            if (e.target.closest('.module-card')) {
                e.preventDefault();
                const menu = document.getElementById('contextMenu');
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                menu.classList.add('show');
            }
        });
        
        document.addEventListener('click', function() {
            document.getElementById('contextMenu').classList.remove('show');
        });
        
        // Переключение модулей
        document.querySelectorAll('.module-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Всегда обновляем активное состояние и подменю
                document.querySelectorAll('.module-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                
                const moduleName = this.dataset.module;
                updateSubmenu(moduleName);
                
                // Если нет href, предотвращаем переход
                if (!this.hasAttribute('href')) {
                    e.preventDefault();
                }
            });
        });
        
        // --- ToDo задачи (C&B реальные задачи) ---
        let todoTasks = [
            {id:1, title:'Провести индексацию зарплат', desc:'Провести индексацию зарплат сотрудников согласно инфляции за первое полугодие. Срок: до 20 июня.', status:'На согласование'},
            {id:2, title:'Проверить корректность начисления бонусов', desc:'Проверить начисления бонусов за май, выявить и исправить возможные ошибки. Срок: до 10 июня.', status:'На исполнение'},
            {id:3, title:'Согласовать бюджет на льготы', desc:'Провести согласование бюджета на корпоративные льготы на Q3. Срок: до 25 июня.', status:'На утверждение'},
            {id:4, title:'Обновить грейды сотрудников', desc:'Провести пересмотр грейдов по итогам оценки эффективности. Срок: до 30 июня.', status:'Для информации'}
        ];
        function getStatusBadge(status) {
            switch(status) {
                case 'На согласование': return "<span class='badge bg-info-subtle text-info me-2'>На согласование</span>";
                case 'На резолюции': return "<span class='badge bg-primary-subtle text-primary me-2'>На резолюции</span>";
                case 'На утверждение': return "<span class='badge bg-warning-subtle text-warning me-2'>На утверждение</span>";
                case 'На исполнение': return "<span class='badge bg-success-subtle text-success me-2'>На исполнение</span>";
                case 'Для информации': return "<span class='badge bg-secondary-subtle text-secondary me-2'>Для информации</span>";
                default: return "<span class='badge bg-light text-dark me-2'>Без статуса</span>";
            }
        }
        function renderTodoList() {
            const el = document.getElementById('todoList');
            if (!el) return;
            if (!todoTasks.length) {
                el.innerHTML = `<li class='list-group-item text-muted text-center'>Нет актуальных задач</li>`;
                return;
            }
            el.innerHTML = todoTasks.map(task =>
                `<li class='list-group-item d-flex justify-content-between align-items-center todo-item' data-id='${task.id}' onclick='onTodoRowClick(event,${task.id})'>
                    <div class='d-flex align-items-center gap-2'>
                        <span class='badge bg-primary-subtle text-primary me-2'><i class='bi bi-clipboard-check'></i></span>
                        <span class='fw-semibold'>${task.title}</span>
                    </div>
                    <div class='d-flex align-items-center gap-2'>
                        ${getStatusBadge(task.status)}
                        <button class='btn btn-success btn-sm' title='Завершить' onclick='completeTodoTask(${task.id}, event)'><i class='bi bi-check-lg'></i></button>
                    </div>
                </li>`
            ).join('');
        }
        function onTodoRowClick(event, id) {
            // Не открывать модалку при клике по кнопке
            if (event.target.closest('button')) return;
            openTodoModal(id);
        }
        function completeTodoTask(id, event) {
            event.stopPropagation();
            todoTasks = todoTasks.filter(t=>t.id!==id);
            renderTodoList();
        }
        function openTodoModal(id) {
            const task = todoTasks.find(t=>t.id===id);
            if (!task) return;
            document.getElementById('todoModalTitle').textContent = task.title;
            document.getElementById('todoModalDesc').textContent = task.desc;
            const completeBtn = document.getElementById('todoCompleteBtn');
            completeBtn.onclick = function() {
                todoTasks = todoTasks.filter(t=>t.id!==id);
                renderTodoList();
                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('todoModal'));
                modal.hide();
            };
            const modal = new bootstrap.Modal(document.getElementById('todoModal'));
            modal.show();
        }
        function addTodoTask() {
            const title = prompt('Введите заголовок задачи:');
            if (!title) return;
            const desc = prompt('Введите описание задачи:');
            const status = prompt('Введите статус задачи:');
            todoTasks.push({id:Date.now(), title, desc, status});
            renderTodoList();
        }
        // Инициализация задач после полной загрузки страницы
        window.addEventListener('load', function() {
            // Показываем подменю C&B сразу
            updateSubmenu('cb');
            // Активируем только подменю 'Зарплаты', снимаем active со всех остальных
            setTimeout(function() {
                var submenuItems = document.querySelectorAll('#moduleSubmenu .submenu-item');
                if (submenuItems.length) {
                    submenuItems.forEach(i => i.classList.remove('active'));
                    submenuItems.forEach(item => {
                        if (item.textContent.trim().includes('Зарплаты')) {
                            item.classList.add('active');
                        }
                    });
                }
            }, 0);
            // Инициализация футера с задачами
            setTimeout(() => {
                initTasksFooter();
            }, 100);
            
            // Обновление задач при изменении размера окна
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    updateTasksDisplay();
                }, 250);
            });
            
            // Анимация появления модулей
            const modules = document.querySelectorAll('.module-card');
            modules.forEach((module, index) => {
                module.style.opacity = '0';
                module.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    module.style.transition = 'all 0.3s ease';
                    module.style.opacity = '1';
                    module.style.transform = 'translateY(0)';
                }, index * 50);
            });
            // Вызов рендера ToDo-блока
            renderTodoList();
        });

        // --- Данные для медианной ЗП по месяцам двух лет ---
        const medianSalaryData = {
            months: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'],
            prev: [370000, 372000, 375000, 378000, 380000, 382000, 385000, 388000, 390000, 392000, 395000, 398000],
            curr: [400000, 405000, 410000, 415000, 420000, 420000, 422000, 425000, 427000, 430000, 432000, 435000]
        };

        // Медианная ЗП (график: оба года на одной оси, до текущего месяца)
        if (document.getElementById('medianSalaryChart')) {
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-янв, 11-дек
            const months = medianSalaryData.months;
            const prev = medianSalaryData.prev;
            // Для текущего года: после текущего месяца — null
            const curr = medianSalaryData.curr.map((val, idx) => idx <= currentMonth ? val : null);
            const ctx = document.getElementById('medianSalaryChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Прошлый год',
                            data: prev,
                            borderColor: '#bdbdbd',
                            backgroundColor: 'rgba(189,189,189,0.08)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 2
                        },
                        {
                            label: 'Текущий год',
                            data: curr,
                            borderColor: '#43a047',
                            backgroundColor: 'rgba(67,160,71,0.08)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    const prevVal = prev[idx];
                                    const currVal = medianSalaryData.curr[idx];
                                    let lines = [];
                                    if (context.dataset.label === 'Текущий год') {
                                        if (currVal !== null) {
                                            lines.push('Текущий год: ' + (currVal ? currVal.toLocaleString()+'₸' : '—'));
                                            if (prevVal && currVal !== null && currVal !== undefined) {
                                                const diff = currVal - prevVal;
                                                const percent = ((currVal/prevVal-1)*100).toFixed(1);
                                                const sign = diff>0?'+':'';
                                                lines.push(`Разница: ${sign}${diff.toLocaleString()}₸ (${sign}${percent}%)`);
                                            }
                                        }
                                        return lines;
                                    } else {
                                        lines.push('Прошлый год: ' + (prevVal ? prevVal.toLocaleString()+'₸' : '—'));
                                        return lines;
                                    }
                                }
                            }
                        }
                    },
                    scales: { y: { beginAtZero: false } }
                }
            });
            // --- Вычисления разницы (по последнему месяцу) ---
            const prevYearLast = prev[currentMonth];
            const currYearLast = medianSalaryData.curr[currentMonth];
            const yearDiff = currYearLast - prevYearLast;
            const yearDiffPercent = ((currYearLast/prevYearLast-1)*100).toFixed(1);
            // Кварталы: Q2 = апр-июн, Q1 = янв-мар (по текущему году)
            const prevQ = medianSalaryData.curr.slice(0,3).reduce((a,b)=>a+b,0)/3;
            const currQ = medianSalaryData.curr.slice(3,6).reduce((a,b)=>a+b,0)/3;
            const qDiff = currQ - prevQ;
            const qDiffPercent = ((currQ/prevQ-1)*100).toFixed(1);
            // Вставить текстовые значения в одну строку
            const salaryInfo = document.getElementById('medianSalaryInfo');
            if (salaryInfo) {
                salaryInfo.innerHTML =
                    `<span class='small text-muted'>Год к году: <span class='fw-semibold text-${yearDiff>0?'success':'danger'}'>${yearDiff>0?'+':''}${yearDiff.toLocaleString()}₸ (${yearDiffPercent}%)</span></span>`+
                    `<span class='px-1 text-muted'>|</span>`+
                    `<span class='small text-muted'>Q2 к Q1: <span class='fw-semibold text-${qDiff>0?'success':'danger'}'>${qDiff>0?'+':''}${qDiff.toLocaleString()}₸ (${qDiffPercent}%)</span></span>`;
            }
        }
        // ФОТ
        if (document.getElementById('payrollChart')) {
            const ctx = document.getElementById('payrollChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн'],
                    datasets: [{
                        label: 'ФОТ',
                        data: [42000000, 43000000, 44000000, 44500000, 45000000, 45000000],
                        backgroundColor: '#1976f8',
                        borderRadius: 8
                    }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
            });
        }
        // Бюджет на льготы
        if (document.getElementById('benefitsChart')) {
            const ctx = document.getElementById('benefitsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн'],
                    datasets: [{
                        label: 'Бюджет на льготы',
                        data: [4800000, 4900000, 4950000, 5000000, 5000000, 5000000],
                        backgroundColor: '#00bcd4',
                        borderRadius: 8
                    }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
            });
        }

        const salarySections = {
            employees: `
                <h3 class='mb-4'><i class="bi bi-people me-2"></i>Сотрудники</h3>
                <div class='card mb-4'>
                    <div class='card-header d-flex align-items-center justify-content-between'>
                        <span>Таблица зарплат сотрудников</span>
                        <button class='btn btn-sm btn-outline-primary'><i class='bi bi-plus'></i> Добавить</button>
                    </div>
                    <div class='card-body p-0'>
                        <div class='table-responsive'>
                            <table class='table table-hover mb-0'>
                                <thead>
                                    <tr><th>ФИО</th><th>Должность</th><th>Подразделение</th><th>Зарплата</th><th>Дата изменения</th><th></th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Иванов Иван</td><td>Разработчик</td><td>ИТ</td><td>₸ 400,000</td><td>01.06.2024</td><td><button class='btn btn-sm btn-light'>Подробнее</button></td></tr>
                                    <tr><td>Петров Петр</td><td>Аналитик</td><td>Бизнес</td><td>₸ 350,000</td><td>28.05.2024</td><td><button class='btn btn-sm btn-light'>Подробнее</button></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `,
            ranges: `
                <h3 class='mb-4'><i class="bi bi-sliders me-2"></i>Вилки</h3>
                <div class='card'>
                    <div class='card-header'>Диапазоны зарплат по грейдам</div>
                    <div class='card-body'>
                        <div class='table-responsive'>
                            <table class='table table-bordered'>
                                <thead><tr><th>Грейд</th><th>Минимум</th><th>Максимум</th></tr></thead>
                                <tbody>
                                    <tr><td>Junior</td><td>₸ 200,000</td><td>₸ 300,000</td></tr>
                                    <tr><td>Middle</td><td>₸ 300,000</td><td>₸ 450,000</td></tr>
                                    <tr><td>Senior</td><td>₸ 450,000</td><td>₸ 700,000</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `,
            benchmarks: `
                <h3 class='mb-4'><i class="bi bi-bar-chart-line me-2"></i>Бенчмарки</h3>
                <div class='card'>
                    <div class='card-body pb-2'>
                        <form class='row g-2 align-items-end mb-3' id='benchmarksFilters'>
                            <div class='col-md-3'>
                                <label class='form-label mb-1'>Локация</label>
                                <select class='form-select form-select-sm' id='benchLocation'>
                                    <option value=''>Все</option>
                                    <option value='Москва'>Москва</option>
                                    <option value='Санкт-Петербург'>Санкт-Петербург</option>
                                    <option value='Казань'>Казань</option>
                                    <option value='Екатеринбург'>Екатеринбург</option>
                                    <option value='Новосибирск'>Новосибирск</option>
                                </select>
                            </div>
                            <div class='col-md-3'>
                                <label class='form-label mb-1'>Сектор</label>
                                <select class='form-select form-select-sm' id='benchSector'>
                                    <option value=''>Все</option>
                                    <option value='IT'>IT</option>
                                    <option value='Финансы'>Финансы</option>
                                    <option value='Маркетинг'>Маркетинг</option>
                                    <option value='HR'>HR</option>
                                </select>
                            </div>
                            <div class='col-md-2'>
                                <label class='form-label mb-1'>Специализация</label>
                                <select class='form-select form-select-sm' id='benchSpecialization'>
                                    <option value=''>Все</option>
                                    <option value='Frontend'>Frontend</option>
                                    <option value='Backend'>Backend</option>
                                    <option value='QA'>QA</option>
                                    <option value='Product'>Product</option>
                                    <option value='DevOps'>DevOps</option>
                                </select>
                            </div>
                            <div class='col-md-2'>
                                <label class='form-label mb-1'>Грейд</label>
                                <select class='form-select form-select-sm' id='benchGrade'>
                                    <option value=''>Все</option>
                                    <option value='Junior'>Junior</option>
                                    <option value='Middle'>Middle</option>
                                    <option value='Senior'>Senior</option>
                                    <option value='Lead'>Lead</option>
                                </select>
                            </div>
                            <div class='col-md-2'>
                                <label class='form-label mb-1'>Валюта</label>
                                <select class='form-select form-select-sm' id='benchCurrency'>
                                    <option value='RUB'>RUB</option>
                                    <option value='USD'>USD</option>
                                    <option value='KZT'>KZT</option>
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
                <div class='card'>
                    <div class='card-header'>График медиан</div>
                    <div class='card-body'>
                        <canvas id='benchmarksChart' height='120'></canvas>
                    </div>
                </div>
                <div class='card'>
                    <div class='card-header'>Таблица бенчмарков</div>
                    <div class='card-body p-0'>
                        <div class='table-responsive'>
                            <table class='table table-hover table-striped table-sm mb-0'>
                                <thead>
                                    <tr>
                                        <th>Специализация</th>
                                        <th>Грейд</th>
                                        <th>Мин. ЗП</th>
                                        <th>Макс. ЗП</th>
                                        <th>Мин. запрос</th>
                                        <th>Макс. запрос</th>
                                    </tr>
                                </thead>
                                <tbody id='benchmarksTableBody'>
                                    <tr>
                                        <td>Frontend</td>
                                        <td>Junior</td>
                                        <td>80000</td>
                                        <td>120000</td>
                                        <td>100000</td>
                                        <td>150000</td>
                                    </tr>
                                    <tr>
                                        <td>Frontend</td>
                                        <td>Junior+</td>
                                        <td>100000</td>
                                        <td>150000</td>
                                        <td>120000</td>
                                        <td>180000</td>
                                    </tr>
                                    <tr>
                                        <td>Frontend</td>
                                        <td>Middle</td>
                                        <td>150000</td>
                                        <td>250000</td>
                                        <td>180000</td>
                                        <td>300000</td>
                                    </tr>
                                    <tr>
                                        <td>Frontend</td>
                                        <td>Middle+</td>
                                        <td>200000</td>
                                        <td>300000</td>
                                        <td>250000</td>
                                        <td>350000</td>
                                    </tr>
                                    <tr>
                                        <td>Frontend</td>
                                        <td>Senior</td>
                                        <td>250000</td>
                                        <td>400000</td>
                                        <td>300000</td>
                                        <td>500000</td>
                                    </tr>
                                    <tr>
                                        <td>Frontend</td>
                                        <td>Senior+</td>
                                        <td>300000</td>
                                        <td>500000</td>
                                        <td>350000</td>
                                        <td>600000</td>
                                    </tr>
                                    <tr>
                                        <td>Frontend</td>
                                        <td>Lead</td>
                                        <td>400000</td>
                                        <td>600000</td>
                                        <td>450000</td>
                                        <td>700000</td>
                                    </tr>
                                    <tr>
                                        <td>Frontend</td>
                                        <td>Head</td>
                                        <td>500000</td>
                                        <td>800000</td>
                                        <td>600000</td>
                                        <td>900000</td>
                                    </tr>
                                    <tr>
                                        <td>Backend</td>
                                        <td>Junior</td>
                                        <td>90000</td>
                                        <td>130000</td>
                                        <td>110000</td>
                                        <td>160000</td>
                                    </tr>
                                    <tr>
                                        <td>Backend</td>
                                        <td>Junior+</td>
                                        <td>110000</td>
                                        <td>160000</td>
                                        <td>130000</td>
                                        <td>190000</td>
                                    </tr>
                                    <tr>
                                        <td>Backend</td>
                                        <td>Middle</td>
                                        <td>160000</td>
                                        <td>260000</td>
                                        <td>190000</td>
                                        <td>310000</td>
                                    </tr>
                                    <tr>
                                        <td>Backend</td>
                                        <td>Middle+</td>
                                        <td>210000</td>
                                        <td>310000</td>
                                        <td>260000</td>
                                        <td>360000</td>
                                    </tr>
                                    <tr>
                                        <td>Backend</td>
                                        <td>Senior</td>
                                        <td>260000</td>
                                        <td>410000</td>
                                        <td>310000</td>
                                        <td>510000</td>
                                    </tr>
                                    <tr>
                                        <td>Backend</td>
                                        <td>Senior+</td>
                                        <td>310000</td>
                                        <td>510000</td>
                                        <td>360000</td>
                                        <td>610000</td>
                                    </tr>
                                    <tr>
                                        <td>Backend</td>
                                        <td>Lead</td>
                                        <td>410000</td>
                                        <td>610000</td>
                                        <td>460000</td>
                                        <td>710000</td>
                                    </tr>
                                    <tr>
                                        <td>Backend</td>
                                        <td>Head</td>
                                        <td>510000</td>
                                        <td>810000</td>
                                        <td>610000</td>
                                        <td>910000</td>
                                    </tr>
                                    <tr>
                                        <td>QA</td>
                                        <td>Junior</td>
                                        <td>70000</td>
                                        <td>110000</td>
                                        <td>90000</td>
                                        <td>140000</td>
                                    </tr>
                                    <tr>
                                        <td>QA</td>
                                        <td>Junior+</td>
                                        <td>90000</td>
                                        <td>140000</td>
                                        <td>110000</td>
                                        <td>170000</td>
                                    </tr>
                                    <tr>
                                        <td>QA</td>
                                        <td>Middle</td>
                                        <td>140000</td>
                                        <td>240000</td>
                                        <td>170000</td>
                                        <td>290000</td>
                                    </tr>
                                    <tr>
                                        <td>QA</td>
                                        <td>Middle+</td>
                                        <td>190000</td>
                                        <td>290000</td>
                                        <td>240000</td>
                                        <td>340000</td>
                                    </tr>
                                    <tr>
                                        <td>QA</td>
                                        <td>Senior</td>
                                        <td>240000</td>
                                        <td>390000</td>
                                        <td>290000</td>
                                        <td>490000</td>
                                    </tr>
                                    <tr>
                                        <td>QA</td>
                                        <td>Senior+</td>
                                        <td>290000</td>
                                        <td>490000</td>
                                        <td>340000</td>
                                        <td>590000</td>
                                    </tr>
                                    <tr>
                                        <td>QA</td>
                                        <td>Lead</td>
                                        <td>390000</td>
                                        <td>590000</td>
                                        <td>440000</td>
                                        <td>690000</td>
                                    </tr>
                                    <tr>
                                        <td>QA</td>
                                        <td>Head</td>
                                        <td>490000</td>
                                        <td>790000</td>
                                        <td>590000</td>
                                        <td>890000</td>
                                    </tr>
                                    <tr>
                                        <td>Product</td>
                                        <td>Junior</td>
                                        <td>100000</td>
                                        <td>140000</td>
                                        <td>120000</td>
                                        <td>170000</td>
                                    </tr>
                                    <tr>
                                        <td>Product</td>
                                        <td>Junior+</td>
                                        <td>120000</td>
                                        <td>170000</td>
                                        <td>140000</td>
                                        <td>200000</td>
                                    </tr>
                                    <tr>
                                        <td>Product</td>
                                        <td>Middle</td>
                                        <td>170000</td>
                                        <td>270000</td>
                                        <td>200000</td>
                                        <td>320000</td>
                                    </tr>
                                    <tr>
                                        <td>Product</td>
                                        <td>Middle+</td>
                                        <td>220000</td>
                                        <td>320000</td>
                                        <td>270000</td>
                                        <td>370000</td>
                                    </tr>
                                    <tr>
                                        <td>Product</td>
                                        <td>Senior</td>
                                        <td>270000</td>
                                        <td>420000</td>
                                        <td>320000</td>
                                        <td>520000</td>
                                    </tr>
                                    <tr>
                                        <td>Product</td>
                                        <td>Senior+</td>
                                        <td>320000</td>
                                        <td>520000</td>
                                        <td>370000</td>
                                        <td>620000</td>
                                    </tr>
                                    <tr>
                                        <td>Product</td>
                                        <td>Lead</td>
                                        <td>420000</td>
                                        <td>620000</td>
                                        <td>470000</td>
                                        <td>720000</td>
                                    </tr>
                                    <tr>
                                        <td>Product</td>
                                        <td>Head</td>
                                        <td>520000</td>
                                        <td>820000</td>
                                        <td>620000</td>
                                        <td>920000</td>
                                    </tr>
                                    <tr>
                                        <td>DevOps</td>
                                        <td>Junior</td>
                                        <td>95000</td>
                                        <td>135000</td>
                                        <td>115000</td>
                                        <td>165000</td>
                                    </tr>
                                    <tr>
                                        <td>DevOps</td>
                                        <td>Junior+</td>
                                        <td>115000</td>
                                        <td>165000</td>
                                        <td>135000</td>
                                        <td>195000</td>
                                    </tr>
                                    <tr>
                                        <td>DevOps</td>
                                        <td>Middle</td>
                                        <td>165000</td>
                                        <td>265000</td>
                                        <td>195000</td>
                                        <td>315000</td>
                                    </tr>
                                    <tr>
                                        <td>DevOps</td>
                                        <td>Middle+</td>
                                        <td>215000</td>
                                        <td>315000</td>
                                        <td>265000</td>
                                        <td>365000</td>
                                    </tr>
                                    <tr>
                                        <td>DevOps</td>
                                        <td>Senior</td>
                                        <td>265000</td>
                                        <td>415000</td>
                                        <td>315000</td>
                                        <td>515000</td>
                                    </tr>
                                    <tr>
                                        <td>DevOps</td>
                                        <td>Senior+</td>
                                        <td>315000</td>
                                        <td>515000</td>
                                        <td>365000</td>
                                        <td>615000</td>
                                    </tr>
                                    <tr>
                                        <td>DevOps</td>
                                        <td>Lead</td>
                                        <td>415000</td>
                                        <td>615000</td>
                                        <td>465000</td>
                                        <td>715000</td>
                                    </tr>
                                    <tr>
                                        <td>DevOps</td>
                                        <td>Head</td>
                                        <td>515000</td>
                                        <td>815000</td>
                                        <td>615000</td>
                                        <td>915000</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `,
            vacancies: '',
            report: `
                <h3 class='mb-4'><i class="bi bi-file-earmark-bar-graph me-2"></i>Общий отчет</h3>
                <div class='card'>
                    <div class='card-header'>Сводная статистика по вакансиям</div>
                    <div class='card-body'>
                        <form class='row g-2 mb-3'>
                            <div class='col-md-3'><input type='text' class='form-control' placeholder='Специализация'></div>
                            <div class='col-md-2'><input type='text' class='form-control' placeholder='Грейд'></div>
                            <div class='col-md-3'><input type='text' class='form-control' placeholder='Локация'></div>
                            <div class='col-md-2'><button class='btn btn-primary w-100' type='button'>Только РБ</button></div>
                            <div class='col-md-2'><button class='btn btn-outline-primary w-100' type='button'>Поиск</button></div>
                        </form>
                        <ul class='nav nav-tabs mb-3' id='pivotTabs' role='tablist'>
                            <li class='nav-item' role='presentation'>
                                <button class='nav-link active' id='summary-tab' data-bs-toggle='tab' data-bs-target='#summary' type='button' role='tab'>Сводные данные</button>
                            </li>
                            <li class='nav-item' role='presentation'>
                                <button class='nav-link' id='infograph-tab' data-bs-toggle='tab' data-bs-target='#infograph' type='button' role='tab'>Инфо-графики</button>
                            </li>
                        </ul>
                        <div class='tab-content'>
                            <div class='tab-pane fade show active' id='summary' role='tabpanel'>
                                <div class='table-responsive'>
                                    <table class='table table-bordered'>
                                        <thead><tr><th>Geo</th><th>Специализация</th><th>Грейд</th><th>Минимум (gross)</th><th>Максимум (gross)</th><th>Медиана рынка (gross)</th><th>Валюта</th></tr></thead>
                                        <tbody>
                                            <tr><td>Georgia</td><td></td><td></td><td>200000</td><td>300000</td><td>250000</td><td>KZT</td></tr>
                                            <tr><td>U.S.</td><td></td><td></td><td>80000</td><td>174419</td><td>116279</td><td>RUB</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class='tab-pane fade' id='infograph' role='tabpanel'>
                                <div class='alert alert-secondary'>Здесь будут инфо-графики и визуализации.</div>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            settings: `
              <h3 class='mb-4'><i class="bi bi-gear me-2"></i>Настройки C&B</h3>
              <div class='card mb-3'>
                <div class='card-body'>
                  <form id='cbSettingsForm'>
                    <div class='mb-3'>
                      <label class='form-label'>Локации поиска</label>
                      <select class='form-select form-select-sm' id='cbLocations' multiple>
                        <option value='Москва'>Москва</option>
                        <option value='Санкт-Петербург'>Санкт-Петербург</option>
                        <option value='Казань'>Казань</option>
                        <option value='Екатеринбург'>Екатеринбург</option>
                        <option value='Новосибирск'>Новосибирск</option>
                      </select>
                    </div>
                    <div class='mb-3'>
                      <label class='form-label'>Промпт для ИИ</label>
                      <textarea class='form-control form-control-sm' id='cbAIPrompt' rows='2' placeholder='Введите промпт для обработки с помощью ИИ'></textarea>
                    </div>
                    <div class='mb-3'>
                      <label class='form-label'>Валюта по умолчанию</label>
                      <select class='form-select form-select-sm' id='cbDefaultCurrency'>
                        <option value='RUB'>RUB</option>
                        <option value='USD'>USD</option>
                        <option value='KZT'>KZT</option>
                      </select>
                    </div>
                    <div class='mb-3 row'>
                      <div class='col-md-6'>
                        <label class='form-label'>Период хранения в активном разделе (мес.)</label>
                        <input type='number' class='form-control form-control-sm' id='cbActivePeriod' min='1' max='60' value='12'>
                      </div>
                      <div class='col-md-6'>
                        <label class='form-label'>Период хранения в архиве (мес.)</label>
                        <input type='number' class='form-control form-control-sm' id='cbArchivePeriod' min='1' max='120' value='36'>
                      </div>
                    </div>
                    <div class='mb-3 row'>
                      <div class='col-md-4'>
                        <label class='form-label'>Формула расчёта</label>
                        <select class='form-select form-select-sm' id='cbSalaryFormula'>
                          <option value='gross'>Gross (брутто) из Net</option>
                          <option value='net'>Net (нетто) из Gross</option>
                        </select>
                      </div>
                      <div class='col-md-8'>
                        <label class='form-label'>Формула</label>
                        <div class='input-group'>
                          <span class='input-group-text' id='formulaLabel'>Gross =</span>
                          <input type='text' class='form-control form-control-sm' id='cbCustomFormula' placeholder='Например: Net / 0.87' style='font-family:monospace;'>
                          <button type='button' class='btn btn-outline-secondary btn-sm' id='insertVarBtn' tabindex='-1'>Вставить Net</button>
                        </div>
                        <div id='cbFormulaExample' class='form-text mt-1'></div>
                        <div id='cbFormulaTable' class='mt-2'></div>
                      </div>
                    </div>
                    <button type='button' class='btn btn-primary btn-sm' id='saveCbSettings'>Сохранить настройки</button>
                  </form>
                </div>
              </div>
            `,
            archive: ''
        };
        function renderSalarySection(section) {
          document.querySelectorAll('#salaryMenu .list-group-item').forEach(item => item.classList.remove('active'));
          const activeBtn = document.querySelector(`#salaryMenu .list-group-item[data-section="${section}"]`);
          if (activeBtn) activeBtn.classList.add('active');
          document.getElementById('salaryMainContent').innerHTML = salarySections[section];
          window.scrollTo({top: 0, behavior: 'smooth'});
          if(section === 'vacancies' && window.initVacanciesSection) window.initVacanciesSection();
          if(section === 'archive' && window.initArchiveSection) window.initArchiveSection();
          if(section === 'settings' && window.initSettingsSection) window.initSettingsSection();
          if(section === 'benchmarks' && window.initBenchmarksSection) window.initBenchmarksSection();
        }
        // Переопределяю рендер раздела 'Внешние вакансии'
        salarySections.vacancies = '';
        // --- Поддержка ?section=... в URL для сохранения выбранного раздела ---
        function setSectionInUrl(section) {
          const url = new URL(window.location);
          url.searchParams.set('section', section);
          window.history.replaceState({}, '', url);
        }
        function getSectionFromUrl() {
          const url = new URL(window.location);
          return url.searchParams.get('section');
        }
        // Удаляю salarySections.archive и патчу функцию рендера раздела
        if (salarySections && salarySections.archive) delete salarySections.archive;

        function renderSalarySectionPatched(section) {
          window.currentSection = section;
          setSectionInUrl(section);
          document.querySelectorAll('#salaryMenu .list-group-item').forEach(item => item.classList.remove('active'));
          const activeBtn = document.querySelector(`#salaryMenu .list-group-item[data-section="${section}"]`);
          if (activeBtn) activeBtn.classList.add('active');
          if (section === 'vacancies') {
            renderVacanciesTable(1);
          } else if (section === 'archive') {
            renderArchivedTable(1);
          } else {
            document.getElementById('salaryMainContent').innerHTML = salarySections[section];
          }
          window.scrollTo({top: 0, behavior: 'smooth'});
          if(section === 'benchmarks' && window.Chart) {
            setTimeout(()=>{
              const ctx = document.getElementById('benchmarksChart').getContext('2d');
              new Chart(ctx, {
                type: 'line',
                data: {
                  labels: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн'],
                  datasets: [
                    {label:'Компания',data:[400000,420000,430000,440000,450000,455000],borderColor:'#1976f8',backgroundColor:'rgba(25,118,248,0.08)',tension:0.4,fill:true},
                    {label:'Рынок',data:[410000,415000,420000,430000,440000,450000],borderColor:'#43a047',backgroundColor:'rgba(67,160,71,0.08)',tension:0.4,fill:true}
                  ]
                },
                options: {plugins:{legend:{display:true}},scales:{y:{beginAtZero:false}}}
              });
            }, 100);
          }
        }
        // Переопределяю обработчики меню
        Array.from(document.querySelectorAll('#salaryMenu .list-group-item')).forEach(item => {
          item.removeEventListener && item.removeEventListener('click', item._salaryClickHandler);
          item._salaryClickHandler = function() { renderSalarySectionPatched(this.dataset.section); };
          item.addEventListener('click', item._salaryClickHandler);
        });
        window.renderSalarySection = renderSalarySectionPatched;
        // По умолчанию — сотрудники
        const sectionFromUrl = getSectionFromUrl();
        window.currentSection = sectionFromUrl || 'employees';
        renderSalarySectionPatched(sectionFromUrl || 'employees');

        // После инициализации переключателей форм модалки:
        ['addVacancyFormText','addVacancyFormFile','addVacancyFormLink','addVacancyFormTable'].forEach(function(formId) {
          const form = document.getElementById(formId);
          if (form && !form._submitHandler) {
            form._submitHandler = true;
            form.addEventListener('submit', function(e) {
              e.preventDefault();
              const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addVacancyModal'));
              modal.hide();
              setTimeout(()=>{
                const url = new URL(window.location);
                url.search = '';
                url.searchParams.set('section', getSectionFromUrl() || 'employees');
                window.location.href = url.pathname + '?' + url.searchParams.toString();
              }, 300);
            });
          }
        });

        document.addEventListener('submit', function(e) {
          if (
            e.target.id === 'addVacancyFormText' ||
            e.target.id === 'addVacancyFormFile' ||
            e.target.id === 'addVacancyFormLink' ||
            e.target.id === 'addVacancyFormTable'
          ) {
            e.preventDefault();
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addVacancyModal'));
            modal.hide();
            setTimeout(()=>{
              const url = new URL(window.location);
              url.search = '';
              url.searchParams.set('section', getSectionFromUrl() || 'employees');
              window.location.href = url.pathname + '?' + url.searchParams.toString();
            }, 300);
          }
        });


        // Обновляем функцию renderSection для поддержки архива
        function renderSection(section) {
          switch(section) {
            case 'employees':
              renderEmployeesTable();
              break;
            case 'ranges':
              renderRangesTable();
              break;
            case 'benchmarks':
              renderBenchmarksTable();
              break;
            case 'vacancies':
              renderVacanciesTable();
              break;
            case 'report':
              renderReport();
              break;
            case 'settings':
              renderSettings();
              break;
            case 'archive':
              renderArchivedTable();
              break;
            default:
              renderDashboard();
          }
        }

        // В функции renderSidebar добавляем пункт меню "Архив"
        function renderSidebar() {
          const currentSection = new URLSearchParams(window.location.search).get('section') || 'dashboard';
          document.getElementById('salarySidebar').innerHTML = `
            <div class='d-flex flex-column h-100'>
              <div class='p-3'>
                <h5 class='mb-3'>C&B</h5>
                <div class='nav flex-column nav-pills'>
                  <a class='nav-link ${currentSection === 'dashboard' ? 'active' : ''}' href='?section=dashboard'>
                    <i class='bi bi-speedometer2 me-2'></i>Дашборд
                  </a>
                  <a class='nav-link ${currentSection === 'employees' ? 'active' : ''}' href='?section=employees'>
                    <i class='bi bi-people me-2'></i>Сотрудники
                  </a>
                  <a class='nav-link ${currentSection === 'ranges' ? 'active' : ''}' href='?section=ranges'>
                    <i class='bi bi-graph-up me-2'></i>Вилки
                  </a>
                  <a class='nav-link ${currentSection === 'benchmarks' ? 'active' : ''}' href='?section=benchmarks'>
                    <i class='bi bi-bar-chart me-2'></i>Бенчмарки
                  </a>
                  <a class='nav-link ${currentSection === 'vacancies' ? 'active' : ''}' href='?section=vacancies'>
                    <i class='bi bi-briefcase me-2'></i>Внешние вакансии
                  </a>
                  <a class='nav-link ${currentSection === 'report' ? 'active' : ''}' href='?section=report'>
                    <i class='bi bi-file-earmark-text me-2'></i>Общий отчет
                  </a>
                  <a class='nav-link ${currentSection === 'settings' ? 'active' : ''}' href='?section=settings'>
                    <i class='bi bi-gear me-2'></i>Настройки
                  </a>
                  <a class='nav-link ${currentSection === 'archive' ? 'active' : ''}' href='?section=archive'>
                    <i class='bi bi-archive me-2'></i>Архив
                  </a>
                </div>
              </div>
            </div>
          `;
        }

        // Обновляем обработчик popstate для поддержки архива
        window.addEventListener('popstate', function() {
          const section = new URLSearchParams(window.location.search).get('section') || 'dashboard';
          renderSection(section);
          renderSidebar();
        });

        // Обновляем обработчик клика по ссылкам в сайдбаре
        document.addEventListener('click', function(e) {
          if (e.target.closest('#salarySidebar .nav-link')) {
            e.preventDefault();
            const section = new URLSearchParams(e.target.closest('.nav-link').href.split('?')[1]).get('section') || 'dashboard';
            window.history.pushState({}, '', `?section=${section}`);
            renderSection(section);
            renderSidebar();
          }
        });

        // 1. Убедиться, что id в archivedVacanciesData совпадают с id из внешних вакансий (оставляю формат 'source-id')
        // 2. В renderArchivedTable добавляю пагинацию:
        function renderPagination(page, totalPages, onPageClick) {
          if (totalPages <= 1) return '';
          let html = `<nav class='d-flex justify-content-center mt-3'><ul class='pagination pagination-sm mb-0'>`;
          if (page > 1) {
            html += `<li class='page-item'><a class='page-link archived-page-link' href='#' data-page='${page-1}'>Предыдущая</a></li>`;
          }
          for (let i = 1; i <= totalPages; i++) {
            html += `<li class='page-item${i === page ? ' active' : ''}'><a class='page-link archived-page-link' href='#' data-page='${i}'>${i}</a></li>`;
          }
          if (page < totalPages) {
            html += `<li class='page-item'><a class='page-link archived-page-link' href='#' data-page='${page+1}'>Следующая</a></li>`;
          }
          html += `</ul></nav>`;
          return html;
        }
        // В renderArchivedTable после таблицы добавляю:
        // + renderPagination(page, totalPages, (p) => renderArchivedTable(p, perPage, search, channel))
        // В обработчике document.addEventListener('click', ...) добавляю обработку .archived-page-link:
        document.addEventListener('click', function(e) {
          // ...
          if (e.target.classList.contains('archived-page-link')) {
            e.preventDefault();
            const page = +e.target.dataset.page;
            renderArchivedTable(page);
          }
          // ...
        });

        // --- ДАННЫЕ ДЛЯ ГРАФИКА ---
        const benchmarkChartData = [
          // Frontend
          { specialization: 'Frontend', grade: 'Junior', filterMedian: 80000, companyMedian: 75000, marketMedian: 85000, candidateMedian: 90000, sector: 'IT', location: 'Москва', currency: 'RUB' },
          { specialization: 'Frontend', grade: 'Junior+', filterMedian: 100000, companyMedian: 95000, marketMedian: 110000, candidateMedian: 120000, sector: 'IT', location: 'Москва', currency: 'RUB' },
          { specialization: 'Frontend', grade: 'Middle', filterMedian: 150000, companyMedian: 145000, marketMedian: 160000, candidateMedian: 170000, sector: 'IT', location: 'Москва', currency: 'RUB' },
          { specialization: 'Frontend', grade: 'Middle+', filterMedian: 200000, companyMedian: 190000, marketMedian: 210000, candidateMedian: 220000, sector: 'IT', location: 'Москва', currency: 'RUB' },
          { specialization: 'Frontend', grade: 'Senior', filterMedian: 250000, companyMedian: 240000, marketMedian: 260000, candidateMedian: 270000, sector: 'IT', location: 'Москва', currency: 'RUB' },
          { specialization: 'Frontend', grade: 'Senior+', filterMedian: 300000, companyMedian: 290000, marketMedian: 310000, candidateMedian: 320000, sector: 'IT', location: 'Москва', currency: 'RUB' },
          { specialization: 'Frontend', grade: 'Lead', filterMedian: 400000, companyMedian: 390000, marketMedian: 410000, candidateMedian: 420000, sector: 'IT', location: 'Москва', currency: 'RUB' },
          { specialization: 'Frontend', grade: 'Head', filterMedian: 500000, companyMedian: 490000, marketMedian: 510000, candidateMedian: 520000, sector: 'IT', location: 'Москва', currency: 'RUB' },
          // Backend
          { specialization: 'Backend', grade: 'Junior', filterMedian: 90000, companyMedian: 85000, marketMedian: 95000, candidateMedian: 100000, sector: 'IT', location: 'Санкт-Петербург', currency: 'RUB' },
          { specialization: 'Backend', grade: 'Junior+', filterMedian: 110000, companyMedian: 105000, marketMedian: 120000, candidateMedian: 130000, sector: 'IT', location: 'Санкт-Петербург', currency: 'RUB' },
          { specialization: 'Backend', grade: 'Middle', filterMedian: 160000, companyMedian: 155000, marketMedian: 165000, candidateMedian: 170000, sector: 'IT', location: 'Санкт-Петербург', currency: 'RUB' },
          { specialization: 'Backend', grade: 'Middle+', filterMedian: 210000, companyMedian: 200000, marketMedian: 220000, candidateMedian: 230000, sector: 'IT', location: 'Санкт-Петербург', currency: 'RUB' },
          { specialization: 'Backend', grade: 'Senior', filterMedian: 260000, companyMedian: 250000, marketMedian: 270000, candidateMedian: 280000, sector: 'IT', location: 'Санкт-Петербург', currency: 'RUB' },
          { specialization: 'Backend', grade: 'Senior+', filterMedian: 310000, companyMedian: 300000, marketMedian: 320000, candidateMedian: 330000, sector: 'IT', location: 'Санкт-Петербург', currency: 'RUB' },
          { specialization: 'Backend', grade: 'Lead', filterMedian: 410000, companyMedian: 400000, marketMedian: 420000, candidateMedian: 430000, sector: 'IT', location: 'Санкт-Петербург', currency: 'RUB' },
          { specialization: 'Backend', grade: 'Head', filterMedian: 510000, companyMedian: 500000, marketMedian: 520000, candidateMedian: 530000, sector: 'IT', location: 'Санкт-Петербург', currency: 'RUB' },
          // QA
          { specialization: 'QA', grade: 'Junior', filterMedian: 70000, companyMedian: 65000, marketMedian: 75000, candidateMedian: 80000, sector: 'IT', location: 'Казань', currency: 'RUB' },
          { specialization: 'QA', grade: 'Junior+', filterMedian: 90000, companyMedian: 85000, marketMedian: 95000, candidateMedian: 100000, sector: 'IT', location: 'Казань', currency: 'RUB' },
          { specialization: 'QA', grade: 'Middle', filterMedian: 140000, companyMedian: 135000, marketMedian: 145000, candidateMedian: 150000, sector: 'IT', location: 'Казань', currency: 'RUB' },
          { specialization: 'QA', grade: 'Middle+', filterMedian: 190000, companyMedian: 180000, marketMedian: 200000, candidateMedian: 210000, sector: 'IT', location: 'Казань', currency: 'RUB' },
          { specialization: 'QA', grade: 'Senior', filterMedian: 240000, companyMedian: 235000, marketMedian: 245000, candidateMedian: 250000, sector: 'IT', location: 'Казань', currency: 'RUB' },
          { specialization: 'QA', grade: 'Senior+', filterMedian: 290000, companyMedian: 280000, marketMedian: 300000, candidateMedian: 310000, sector: 'IT', location: 'Казань', currency: 'RUB' },
          { specialization: 'QA', grade: 'Lead', filterMedian: 390000, companyMedian: 380000, marketMedian: 400000, candidateMedian: 410000, sector: 'IT', location: 'Казань', currency: 'RUB' },
          { specialization: 'QA', grade: 'Head', filterMedian: 490000, companyMedian: 480000, marketMedian: 500000, candidateMedian: 510000, sector: 'IT', location: 'Казань', currency: 'RUB' },
          // Product
          { specialization: 'Product', grade: 'Junior', filterMedian: 100000, companyMedian: 95000, marketMedian: 105000, candidateMedian: 110000, sector: 'Маркетинг', location: 'Екатеринбург', currency: 'RUB' },
          { specialization: 'Product', grade: 'Junior+', filterMedian: 120000, companyMedian: 115000, marketMedian: 130000, candidateMedian: 140000, sector: 'Маркетинг', location: 'Екатеринбург', currency: 'RUB' },
          { specialization: 'Product', grade: 'Middle', filterMedian: 170000, companyMedian: 165000, marketMedian: 175000, candidateMedian: 180000, sector: 'Маркетинг', location: 'Екатеринбург', currency: 'RUB' },
          { specialization: 'Product', grade: 'Middle+', filterMedian: 220000, companyMedian: 210000, marketMedian: 230000, candidateMedian: 240000, sector: 'Маркетинг', location: 'Екатеринбург', currency: 'RUB' },
          { specialization: 'Product', grade: 'Senior', filterMedian: 270000, companyMedian: 265000, marketMedian: 275000, candidateMedian: 280000, sector: 'Маркетинг', location: 'Екатеринбург', currency: 'RUB' },
          { specialization: 'Product', grade: 'Senior+', filterMedian: 320000, companyMedian: 310000, marketMedian: 330000, candidateMedian: 340000, sector: 'Маркетинг', location: 'Екатеринбург', currency: 'RUB' },
          { specialization: 'Product', grade: 'Lead', filterMedian: 420000, companyMedian: 410000, marketMedian: 430000, candidateMedian: 440000, sector: 'Маркетинг', location: 'Екатеринбург', currency: 'RUB' },
          { specialization: 'Product', grade: 'Head', filterMedian: 520000, companyMedian: 510000, marketMedian: 530000, candidateMedian: 540000, sector: 'Маркетинг', location: 'Екатеринбург', currency: 'RUB' },
          // DevOps
          { specialization: 'DevOps', grade: 'Junior', filterMedian: 95000, companyMedian: 90000, marketMedian: 100000, candidateMedian: 105000, sector: 'IT', location: 'Новосибирск', currency: 'RUB' },
          { specialization: 'DevOps', grade: 'Junior+', filterMedian: 115000, companyMedian: 110000, marketMedian: 120000, candidateMedian: 125000, sector: 'IT', location: 'Новосибирск', currency: 'RUB' },
          { specialization: 'DevOps', grade: 'Middle', filterMedian: 165000, companyMedian: 160000, marketMedian: 170000, candidateMedian: 175000, sector: 'IT', location: 'Новосибирск', currency: 'RUB' },
          { specialization: 'DevOps', grade: 'Middle+', filterMedian: 215000, companyMedian: 210000, marketMedian: 220000, candidateMedian: 225000, sector: 'IT', location: 'Новосибирск', currency: 'RUB' },
          { specialization: 'DevOps', grade: 'Senior', filterMedian: 265000, companyMedian: 260000, marketMedian: 270000, candidateMedian: 275000, sector: 'IT', location: 'Новосибирск', currency: 'RUB' },
          { specialization: 'DevOps', grade: 'Senior+', filterMedian: 315000, companyMedian: 310000, marketMedian: 320000, candidateMedian: 325000, sector: 'IT', location: 'Новосибирск', currency: 'RUB' },
          { specialization: 'DevOps', grade: 'Lead', filterMedian: 415000, companyMedian: 410000, marketMedian: 420000, candidateMedian: 425000, sector: 'IT', location: 'Новосибирск', currency: 'RUB' },
          { specialization: 'DevOps', grade: 'Head', filterMedian: 515000, companyMedian: 510000, marketMedian: 520000, candidateMedian: 525000, sector: 'IT', location: 'Новосибирск', currency: 'RUB' }
        ];

        const chartColors = {
          filter: '#1976f8',
          company: '#43a047',
          market: '#fbc02d'
        };

        let chartInstance = null;

        function getSelectedFilters() {
          return {
            location: document.getElementById('benchLocation').value,
            sector: document.getElementById('benchSector').value,
            specialization: document.getElementById('benchSpecialization').value,
            grade: document.getElementById('benchGrade').value,
            currency: document.getElementById('benchCurrency').value
          };
        }

        function filterChartData() {
          const filters = getSelectedFilters();
          return benchmarkChartData.filter(row =>
            (!filters.specialization || row.specialization === filters.specialization) &&
            (!filters.sector || row.sector === filters.sector) &&
            (!filters.location || row.location === filters.location) &&
            (!filters.grade || row.grade === filters.grade) &&
            (!filters.currency || row.currency === filters.currency)
          );
        }

        function renderBenchmarksChart() {
          console.log('Рендер графика бенчмарков');
          const ctx = document.getElementById('benchmarksChart');
          if (!ctx) {
            console.warn('Элемент canvas не найден');
            return;
          }

          const filtered = filterChartData();
          const labels = filtered.map(row => `${row.grade} ${row.specialization}`);
          const filterMedian = filtered.map(row => row.filterMedian);
          const companyMedian = filtered.map(row => row.companyMedian);
          const marketMedian = filtered.map(row => row.marketMedian);

          if (chartInstance) {
            console.log('Уничтожаем старый график');
            chartInstance.destroy();
          }

          console.log('Создаем новый график');
          chartInstance = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: 'Медиана по фильтру',
                  data: filterMedian,
                  borderColor: chartColors.filter,
                  backgroundColor: chartColors.filter + '33',
                  fill: false,
                  tension: 0.3,
                  pointRadius: 4
                },
                {
                  label: 'Медиана по компании',
                  data: companyMedian,
                  borderColor: chartColors.company,
                  backgroundColor: chartColors.company + '33',
                  fill: false,
                  tension: 0.3,
                  pointRadius: 4
                },
                {
                  label: 'Медиана по рынку',
                  data: marketMedian,
                  borderColor: chartColors.market,
                  backgroundColor: chartColors.market + '33',
                  fill: false,
                  tension: 0.3,
                  pointRadius: 4
                }
              ]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: true, position: 'top' },
                tooltip: { enabled: true }
              },
              scales: {
                y: { 
                  beginAtZero: true, 
                  title: { 
                    display: true, 
                    text: 'Зарплата' 
                  } 
                }
              }
            }
          });
        }

        // --- СИНХРОНИЗАЦИЯ ФИЛЬТРОВ, ТАБЛИЦЫ И ГРАФИКА ---
        function updateBenchmarksView() {
          renderBenchmarksChart();
          renderBenchmarksTable();
        }

        document.addEventListener('DOMContentLoaded', function() {
          // Для мультивыбора
          ['benchLocation','benchSector','benchSpecialization'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.setAttribute('multiple', 'multiple');
          });
          // Слушатели фильтров
          ['benchLocation','benchSector','benchSpecialization','benchCurrency'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', updateBenchmarksView);
          });
          updateBenchmarksView();
        });

        function renderBenchmarksTable() {
          console.log('Рендер таблицы бенчмарков');
          const filtered = filterChartData();
          const tbody = document.getElementById('benchmarksTableBody');
          if (!tbody) {
            console.warn('Элемент таблицы не найден');
            return;
          }
          
          // Очищаем таблицу
          tbody.innerHTML = '';
          
          // Заполняем таблицу
          filtered.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row.specialization}</td>
              <td>${row.grade}</td>
              <td>${row.filterMedian.toLocaleString()}</td>
              <td>${row.companyMedian.toLocaleString()}</td>
              <td>${row.marketMedian.toLocaleString()}</td>
              <td>${row.marketMedian.toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
          });
          
          console.log('Таблица обновлена, строк:', filtered.length);
        }

        function initBenchmarksFilters() {
          console.log('Инициализация фильтров бенчмарков');
          ['benchLocation','benchSector','benchSpecialization','benchGrade','benchCurrency'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
              console.log(`Найден фильтр: ${id}`);
              // Убираем множественный выбор
              if (el.hasAttribute('multiple')) {
                el.removeAttribute('multiple');
              }
              // Удаляем старые обработчики
              el.removeEventListener('change', updateBenchmarksView);
              // Добавляем новый обработчик
              el.addEventListener('change', function() {
                console.log(`Изменение фильтра ${id}:`, this.value);
                updateBenchmarksView();
              });
            } else {
              console.warn(`Фильтр не найден: ${id}`);
            }
          });
        }

        function updateBenchmarksView() {
          console.log('Обновление представления бенчмарков');
          const filters = getSelectedFilters();
          console.log('Текущие фильтры:', filters);
          renderBenchmarksChart();
          renderBenchmarksTable();
        }

        function getSelectedFilters() {
          const filters = {
            location: document.getElementById('benchLocation')?.value || '',
            sector: document.getElementById('benchSector')?.value || '',
            specialization: document.getElementById('benchSpecialization')?.value || '',
            grade: document.getElementById('benchGrade')?.value || '',
            currency: document.getElementById('benchCurrency')?.value || ''
          };
          console.log('Получены фильтры:', filters);
          return filters;
        }

        function filterChartData() {
          const filters = getSelectedFilters();
          console.log('Фильтрация данных с фильтрами:', filters);
          const filtered = benchmarkChartData.filter(row => {
            const matches = (!filters.specialization || row.specialization === filters.specialization) &&
                          (!filters.sector || row.sector === filters.sector) &&
                          (!filters.location || row.location === filters.location) &&
                          (!filters.grade || row.grade === filters.grade) &&
                          (!filters.currency || row.currency === filters.currency);
            console.log('Проверка строки:', row, 'Результат:', matches);
            return matches;
          });
          console.log('Отфильтрованные данные:', filtered);
          return filtered;
        }

        // После рендера секции 'Бенчмарки' вызываем:
        // initBenchmarksFilters();
        // updateBenchmarksView();

        // Найдите функцию renderSalarySection или аналогичную, и после вставки salarySections['benchmarks'] добавьте:
        // if(section === 'benchmarks') { initBenchmarksFilters(); updateBenchmarksView(); }
        // ...

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
          console.log('DOM загружен, инициализация бенчмарков');
          const section = new URLSearchParams(window.location.search).get('section') || 'dashboard';
          if (section === 'benchmarks') {
            console.log('Секция бенчмарков активна при загрузке');
            setTimeout(() => {
              initBenchmarksFilters();
              updateBenchmarksView();
            }, 100);
          }
        });

        // Обработчик изменения секции
        function renderSalarySection(section) {
          document.querySelectorAll('#salaryMenu .list-group-item').forEach(item => item.classList.remove('active'));
          const activeBtn = document.querySelector(`#salaryMenu .list-group-item[data-section="${section}"]`);
          if (activeBtn) activeBtn.classList.add('active');
          document.getElementById('salaryMainContent').innerHTML = salarySections[section];
          window.scrollTo({top: 0, behavior: 'smooth'});
          if(section === 'vacancies' && window.initVacanciesSection) window.initVacanciesSection();
          if(section === 'archive' && window.initArchiveSection) window.initArchiveSection();
          if(section === 'settings' && window.initSettingsSection) window.initSettingsSection();
          if(section === 'benchmarks' && window.initBenchmarksSection) window.initBenchmarksSection();
        }

        // Обработчик клика по меню
        document.querySelectorAll('#salaryMenu .list-group-item').forEach(item => {
          item.addEventListener('click', function() {
            const section = this.dataset.section;
            console.log('Клик по меню:', section);
            renderSalarySection(section);
          });
        });

        // --- ИНИЦИАЛИЗАЦИЯ НАСТРОЕК C&B через MutationObserver ---
        (function() {
          let settingsInit = false;
          const grossExample = 'Net / 0.87';
          const netExample = 'Gross * 0.87';
          function tryInitSettingsForm() {
            if (settingsInit) return;
            const formulaSelect = document.getElementById('cbSalaryFormula');
            const formulaInput = document.getElementById('cbCustomFormula');
            const insertVarBtn = document.getElementById('insertVarBtn');
            const formulaLabel = document.getElementById('formulaLabel');
            const formulaExample = document.getElementById('cbFormulaExample');
            const formulaTable = document.getElementById('cbFormulaTable');
            if (!formulaSelect || !formulaInput || !insertVarBtn || !formulaLabel || !formulaExample || !formulaTable) return;
            settingsInit = true;
            function updateFormulaUI() {
              const mode = formulaSelect.value;
              if (mode === 'gross') {
                formulaLabel.textContent = 'Gross =';
                insertVarBtn.textContent = 'Вставить Net';
                formulaInput.placeholder = 'Например: Net / 0.87';
                if (!formulaInput.value || formulaInput.value === netExample) {
                  formulaInput.value = grossExample;
                }
              } else {
                formulaLabel.textContent = 'Net =';
                insertVarBtn.textContent = 'Вставить Gross';
                formulaInput.placeholder = 'Например: Gross * 0.87';
                if (!formulaInput.value || formulaInput.value === grossExample) {
                  formulaInput.value = netExample;
                }
              }
              updateFormulaExample();
            }
            formulaSelect.onchange = updateFormulaUI;
            insertVarBtn.onclick = function(e) {
              e.preventDefault();
              const mode = formulaSelect.value;
              const varName = mode === 'gross' ? 'Net' : 'Gross';
              const input = formulaInput;
              const start = input.selectionStart;
              const end = input.selectionEnd;
              const value = input.value;
              input.value = value.slice(0, start) + varName + value.slice(end);
              input.focus();
              input.setSelectionRange(start+varName.length, start+varName.length);
              updateFormulaExample();
            };
            formulaInput.oninput = updateFormulaExample;
            function updateFormulaExample() {
              const mode = formulaSelect.value;
              const raw = formulaInput.value;
              let example = '';
              let error = '';
              let result = '';
              let inputVar = 100000;
              let formulaVar = mode === 'gross' ? 'Net' : 'Gross';
              let outputVar = mode === 'gross' ? 'Gross' : 'Net';
              formulaInput.style.background = raw.includes(formulaVar) ? '' : '#ffeaea';
              try {
                if (!raw.includes(formulaVar)) throw `Формула должна содержать ${formulaVar}`;
                result = Function(formulaVar, `return Number((${raw}).toFixed(2))`)(inputVar);
                if (!isFinite(result)) throw 'Ошибка вычисления';
              } catch(e) {
                error = typeof e==='string'?e:'Ошибка формулы';
              }
              if (error) {
                example = `<span class='text-danger'>${error}</span>`;
                formulaTable.innerHTML = '';
              } else {
                example = `<span class='text-muted'>Пример: ${formulaVar} = 100000 → ${outputVar} = <b>${result}</b></span>`;
                const values = [50000, 100000, 200000];
                let table = `<table class='table table-sm table-bordered w-auto mt-2'><thead><tr><th>${formulaVar}</th><th>${outputVar}</th></tr></thead><tbody>`;
                for (const v of values) {
                  let r = '';
                  try {
                    r = Function(formulaVar, `return Number((${raw}).toFixed(2))`)(v);
                    if (!isFinite(r)) r = 'Ошибка';
                  } catch {
                    r = 'Ошибка';
                  }
                  table += `<tr><td>${v}</td><td>${r}</td></tr>`;
                }
                table += '</tbody></table>';
                formulaTable.innerHTML = table;
              }
              formulaExample.innerHTML = example;
            }
            updateFormulaUI();
          }
          const observer = new MutationObserver(() => {
            if (document.getElementById('cbSalaryFormula')) {
              tryInitSettingsForm();
            }
          });
          observer.observe(document.body, { childList: true, subtree: true });
        })();

        // ... existing code ...
        function renderVacanciesTable(page = 1, perPage = 10, search = '', channel = '') {
          if (typeof page === 'undefined') page = 1;
          let filtered = externalVacanciesData.filter(v => {
            const q = search.trim().toLowerCase();
            if (channel && v.source !== channel) return false;
            if (!q) return true;
            return (
              (v.source ? v.source + '-' : '') + v.id
            ).toLowerCase().includes(q) ||
              v.title.toLowerCase().includes(q) ||
              v.location.toLowerCase().includes(q) ||
              v.company.toLowerCase().includes(q);
          });
          const total = filtered.length;
          const totalPages = Math.ceil(total / perPage);
          const start = (page - 1) * perPage;
          const end = start + perPage;
          const items = filtered.slice(start, end);
          document.getElementById('salaryMainContent').innerHTML = `
            <div class='d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2'>
              <h3 class='mb-0'><i class="bi bi-briefcase me-2"></i>Внешние вакансии <span class='text-muted fs-6'>(${total})</span></h3>
              <div class='d-flex gap-2'>
                <button class='btn btn-sm btn-outline-primary' data-bs-toggle='modal' data-bs-target='#addVacancyModal'>
                  <i class='bi bi-plus'></i> Добавить новое описание
                </button>
                <select class='form-select form-select-sm' id='vacancyChannelSelect' style='width:160px; min-width:120px; height:32px;'>
                  <option value=''>Все источники</option>
                  <option value='hh'>HeadHunter</option>
                  <option value='ln'>LinkedIn</option>
                  <option value='tg'>Telegram</option>
                  <option value='ex'>Другое</option>
                </select>
                <input type='text' class='form-control form-control-sm vacancy-search-input' style='width:160px; height:32px; font-size:0.98rem;' placeholder='Поиск...' id='vacancySearchInput' value='${search.replace(/'/g, "&#39;")}' autocomplete='off' />
              </div>
            </div>
            <div class='table-responsive'>
              <table class='table table-hover align-middle small p-0' style='font-size:0.92rem;'>
                <thead class='table-light'>
                  <tr>
                    <th style='width: 100px'>ID</th>
                    <th>Название</th>
                    <th>Локация</th>
                    <th>ЗП от</th>
                    <th>ЗП до</th>
                    <th>Валюта</th>
                    <th>Добавлено</th>
                    <th style='width: 100px'>Действие</th>
                  </tr>
                </thead>
                <tbody>
                  ${items.map(v => `
                    <tr>
                      <td class='text-muted'>${v.id}</td>
                      <td>
                        <div class='fw-medium'>${v.title}</div>
                        <div class='text-muted small'>${v.company}</div>
                      </td>
                      <td>${v.location}</td>
                      <td>${v.salary_from?.toLocaleString() || '-'}</td>
                      <td>${v.salary_to?.toLocaleString() || '-'}</td>
                      <td>${v.currency || 'RUB'}</td>
                      <td class='text-muted'>${formatTime(v.added_at)}</td>
                      <td>
                        <button class='btn btn-sm btn-outline-secondary vacancy-info-btn' data-id='${v.id}' data-source='${v.source}'>Info</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${renderPagination(page, totalPages, (p) => renderVacanciesTable(p, perPage, search, channel))}
          `;
          setTimeout(() => {
            const channelSelect = document.getElementById('vacancyChannelSelect');
            if (channelSelect && !channelSelect._handler) {
              channelSelect._handler = true;
              channelSelect.addEventListener('change', function() {
                renderVacanciesTable(1, perPage, document.getElementById('vacancySearchInput')?.value || '', this.value);
              });
            }
            const searchInput = document.getElementById('vacancySearchInput');
            if (searchInput && !searchInput._debounced) {
              let debounceTimer;
              searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                const val = this.value;
                const channelVal = document.getElementById('vacancyChannelSelect')?.value || '';
                debounceTimer = setTimeout(() => {
                  renderVacanciesTable(1, perPage, val, channelVal);
                  setTimeout(() => {
                    const newInput = document.getElementById('vacancySearchInput');
                    if (newInput) {
                      newInput.focus();
                      newInput.setSelectionRange(val.length, val.length);
                    }
                  }, 0);
                }, 200);
              });
              searchInput._debounced = true;
            }
          }, 0);
        }
        // ... existing code ...

        // === ДАННЫЕ ДЛЯ ВНЕШНИХ ВАКАНСИЙ ===
        const externalVacanciesData = [
          { id: 'hh-118673207', source: 'hh', title: 'Мастер массажа в студию', location: 'Ташкент', company: 'Massage Studio', salary_from: 5000000, salary_to: 8000000, currency: 'UZS', added_at: '2024-06-10T12:15:00' },
          { id: 'hh-118041633', source: 'hh', title: 'Руководитель проектов', location: 'Ярославль', company: 'Project Management Co', salary_from: 130000, salary_to: null, currency: 'RUB', added_at: '2024-06-10T13:20:00' },
          { id: 'hh-118041634', source: 'hh', title: 'Frontend Developer', location: 'Москва', company: 'Tech Solutions', salary_from: 200000, salary_to: 300000, currency: 'RUB', added_at: '2024-06-10T14:30:00' },
          { id: 'hh-118041635', source: 'hh', title: 'Backend Developer', location: 'Санкт-Петербург', company: 'Digital Systems', salary_from: 250000, salary_to: 350000, currency: 'RUB', added_at: '2024-06-10T15:45:00' }
        ];
    </script>
    <!-- Модальное окно для добавления вакансии (фиксировано в DOM) -->
    <div class="modal fade" id="addVacancyModal" tabindex="-1" aria-labelledby="addVacancyModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content p-2">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-semibold" id="addVacancyModalLabel">Добавить внешнюю вакансию</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body pt-2">
            <div class="mb-3 d-flex justify-content-center gap-3 flex-wrap">
              <button type="button" class="btn btn-outline-primary btn-sm" id="addVacancyTextBtn">Ввести описание вручную</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="addVacancyFileBtn">Загрузить файл (PDF/DOCX/TXT)</button>
              <button type="button" class="btn btn-outline-info btn-sm" id="addVacancyLinkBtn">Загрузить по ссылке</button>
              <button type="button" class="btn btn-outline-success btn-sm" id="addVacancyTableBtn">Загрузить множество вакансий из таблицы</button>
            </div>
            <form id="addVacancyFormText" style="display:block;">
              <div class="mb-3">
                <label class="form-label">Описание вакансии (текстом)</label>
                <textarea class="form-control" rows="3" name="description"></textarea>
              </div>
              <button type="submit" class="btn btn-primary w-100">Сохранить</button>
            </form>
            <form id="addVacancyFormFile" style="display:none;">
              <div class="mb-3">
                <label class="form-label">Загрузить файл (PDF, DOCX, TXT)</label>
                <input type="file" class="form-control" name="file" accept=".pdf,.doc,.docx,.txt" />
              </div>
              <button type="submit" class="btn btn-primary w-100">Сохранить</button>
            </form>
            <form id="addVacancyFormLink" style="display:none;">
              <div class="mb-3">
                <label class="form-label">Ссылка на вакансию (интернет)</label>
                <input type="url" class="form-control" name="link" placeholder="https://..." />
              </div>
              <button type="submit" class="btn btn-primary w-100">Загрузить по ссылке</button>
            </form>
            <form id="addVacancyFormTable" style="display:none;">
              <div class="mb-3">
                <label class="form-label">Загрузить таблицу вакансий (Excel, CSV)</label>
                <input type="file" class="form-control" name="tablefile" accept=".csv,.xlsx,.xls" />
              </div>
              <button type="submit" class="btn btn-success w-100">Загрузить таблицу</button>
            </form>
          </div>
        </div>
      </div>
    </div>
</body>
</html>